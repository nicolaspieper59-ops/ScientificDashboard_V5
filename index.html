<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>OMNISCIENCE V17 - SOUVERAIN CORE (RECTIFIED)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* Garder votre CSS original, il est excellent pour l'UI */
        :root { --bg-dark: #07070a; --panel-dark: #12121a; --border: #252533; --text-main: #e0e0e0; --col-nav: #00ff88; }
        body { font-family: 'Segoe UI', monospace; margin: 0; background-color: var(--bg-dark); color: var(--text-main); }
        .dashboard-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; padding: 6px; height: 100vh; box-sizing: border-box; }
        section.panel { background: var(--panel-dark); border: 1px solid var(--border); border-radius: 6px; padding: 10px; border-top: 3px solid #333; }
        #map { height: 180px; background: #000; }
        #ui-canvas { width: 100%; height: 120px; object-fit: cover; }
        .data-point { display: flex; justify-content: space-between; font-size: 0.75rem; padding: 2px 0; }
        #hud-overlay { position: fixed; bottom: 10px; right: 10px; width: 300px; background: rgba(0,15,0,0.9); border: 2px solid var(--col-nav); padding: 15px; border-radius: 10px; z-index: 1000; }
        button { background: #222; color: #fff; border: 1px solid #444; padding: 8px; width: 100%; cursor: pointer; }
    </style>
</head>
<body>

<main class="dashboard-container">
    <div class="column-1">
        <section class="panel" style="border-top-color: #00d2ff">
            <h2>Système 128-bit</h2>
            <div class="data-point"><span>UTC</span><span id="utc-datetime">--</span></div>
            <div class="data-point"><span>Lorentz</span><span id="ui-lorentz">1.000</span></div>
            <div id="anomaly-log" style="font-size:0.6rem; color: #0f0; height: 100px; overflow: auto"></div>
        </section>
    </div>
    
    <div class="column-2">
        <section class="panel" style="border-top-color: #00ff88">
            <h2>Navigation SLAM</h2>
            <video id="ui-canvas" autoplay playsinline muted></video>
            <div id="speed-main-display" style="font-size: 1.5rem; text-align: center; color: #0f0">0.0 km/h</div>
            <div id="map"></div>
        </section>
    </div>

    <div class="column-3">
        <section class="panel" style="border-top-color: #ff00ff">
            <h2>Physique G</h2>
            <div class="data-point"><span>G Somigliana</span><span id="g-somigliana">9.8xx</span></div>
            <div class="data-point"><span>Force G Inst.</span><span id="force-g-inst">1.00</span></div>
            <div class="data-point"><span>Pitch / Roll</span><span id="pitch">0°</span> / <span id="roll">0°</span></div>
        </section>
    </div>

    <div class="column-4">
        <section class="panel" style="border-top-color: #ffcc00">
            <h2>Astro / Sextant</h2>
            <div class="data-point"><span>Alt. Soleil</span><span id="sun-alt">--</span></div>
            <div class="data-point"><span>Lat/Lon EKF</span><span id="lat-ekf">0</span> / <span id="lon-ekf">0</span></div>
        </section>
    </div>
</main>

<div id="hud-overlay">
    <div id="sp-main" style="font-size: 2rem; text-align: center">0.0</div>
    <div style="font-size: 0.7rem">DIST: <span id="dist-3d">0</span>m | <span id="statut-meteo">INIT</span></div>
    <button id="main-init-btn">ACTIVER SOUVERAIN CORE</button>
</div>

<script>
const D128 = Decimal.clone({ precision: 128 });
const _128 = (n) => new D128(n || 0);

const OMNI_CORE = {
    active: false,
    lastUpdate: performance.now(),
    frame: 0,
    state: {
        lat: 48.8566, lon: 2.3522, alt: 0,
        vel_ms: _128(0),
        dist_m: _128(0),
        pitch: 0, roll: 0, az: 0
    },

    async boot() {
        if (typeof DeviceMotionEvent.requestPermission === 'function') {
            await DeviceMotionEvent.requestPermission();
        }
        await VISION_SYSTEM.init();
        OMNI_MAP.init();
        
        window.addEventListener('devicemotion', (e) => this.updatePhysics(e));
        window.addEventListener('deviceorientation', (e) => {
            this.state.az = e.alpha;
            this.state.pitch = e.beta; // Inclinaison X
            this.state.roll = e.gamma;  // Inclinaison Y
            document.getElementById('pitch').innerText = e.beta.toFixed(1) + "°";
            document.getElementById('roll').innerText = e.gamma.toFixed(1) + "°";
        });

        this.active = true;
        this.log("Noyau Souverain : Synchronisation temporelle...");
        this.loop();
    },

    updatePhysics(e) {
        if (!this.active) return;
        
        const now = performance.now();
        const dt = _128((now - this.lastUpdate) / 1000);
        this.lastUpdate = now;

        // 1. Calcul de la Gravité Somigliana (Précision WGS84)
        const g_theo = this.getSomigliana(this.state.lat, this.state.alt);
        
        // 2. Accélération brute (incluant gravité)
        const accZ_raw = _128(e.accelerationIncludingGravity.z);
        
        // 3. Correction de l'accélération propre (Projection par Cosines)
        // Note: Si le téléphone est plat, pitch=0, cos(0)=1. On retire g_theo.
        const cosPitch = Math.abs(Math.cos(this.state.pitch * Math.PI / 180));
        const cosRoll = Math.abs(Math.cos(this.state.roll * Math.PI / 180));
        const acc_clean = accZ_raw.minus(g_theo.times(cosPitch).times(cosRoll));

        // 4. Intégration de la vitesse (V = V0 + a*dt)
        // On applique un filtre passe-haut pour éviter la dérive infinie au repos
        if (acc_clean.abs().lt(0.05)) {
            this.state.vel_ms = this.state.vel_ms.times(0.95); // Friction numérique
        } else {
            this.state.vel_ms = this.state.vel_ms.plus(acc_clean.times(dt));
        }

        // 5. Mise à jour Distance
        this.state.dist_m = this.state.dist_m.plus(this.state.vel_ms.abs().times(dt));

        // Update UI
        const kmh = this.state.vel_ms.times(3.6).toNumber();
        document.getElementById('speed-main-display').innerText = kmh.toFixed(1) + " km/h";
        document.getElementById('sp-main').innerText = kmh.toFixed(1);
        document.getElementById('dist-3d').innerText = this.state.dist_m.toFixed(1);
        document.getElementById('force-g-inst').innerText = accZ_raw.dividedBy(9.80665).toFixed(3);
        document.getElementById('g-somigliana').innerText = g_theo.toFixed(5);
        
        // Facteur de Lorentz (Relativité restreinte)
        const c = 299792458;
        const v2_c2 = this.state.vel_ms.pow(2).dividedBy(c * c);
        const lorentz = _128(1).dividedBy(Decimal.sqrt(_128(1).minus(v2_c2)));
        document.getElementById('ui-lorentz').innerText = lorentz.toFixed(12);
    },

    getSomigliana(lat, alt) {
        // 
        const phi = lat * (Math.PI / 180);
        const sin2 = Math.sin(phi)**2;
        // Formule WGS84 rigoureuse
        const g0 = _128(9.7803253359).times(
            _128(1).plus(_128(0.0019318526).times(sin2))
        ).dividedBy(
            Decimal.sqrt(_128(1).minus(_128(0.0066943799).times(sin2)))
        );
        // Correction d'altitude (Free-air correction)
        return g0.plus(_128(-0.000003086).times(alt));
    },

    log(msg) {
        const l = document.getElementById('anomaly-log');
        l.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + l.innerHTML;
    },

    loop() {
        if(this.active) {
            const now = new Date();
            const obs = new Astronomy.Observer(this.state.lat, this.state.lon, this.state.alt);
            
            // Astro-Engine
            const sun = Astronomy.Horizon(now, obs, 
                Astronomy.Equator("Sun", now, obs, true, true).ra, 
                Astronomy.Equator("Sun", now, obs, true, true).dec, "Refraction");
            
            document.getElementById('sun-alt').innerText = sun.altitude.toFixed(2) + "°";
            document.getElementById('utc-datetime').innerText = now.toISOString().substring(11,19);

            // Rendu Sextant AR
            VISION_SYSTEM.drawAR(sun);

            this.frame++;
        }
        requestAnimationFrame(() => this.loop());
    }
};

const VISION_SYSTEM = {
    canvas: null, ctx: null,
    async init() {
        const v = document.getElementById('ui-canvas');
        try {
            const s = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}});
            v.srcObject = s;
            this.canvas = document.createElement('canvas');
            this.canvas.style.position = 'absolute';
            this.canvas.style.top = v.offsetTop + "px";
            this.canvas.style.left = v.offsetLeft + "px";
            this.canvas.width = v.clientWidth; this.canvas.height = v.clientHeight;
            v.parentElement.appendChild(this.canvas);
            this.ctx = this.canvas.getContext('2d');
        } catch(e) { OMNI_CORE.log("Caméra bloquée."); }
    },
    drawAR(sun) {
        if(!this.ctx) return;
        this.ctx.clearRect(0,0,this.canvas.width, this.canvas.height);
        // On centre l'astre selon l'azimuth et le pitch
        const x = (this.canvas.width/2) + (sun.azimuth - OMNI_CORE.state.az)*10;
        const y = (this.canvas.height/2) - (sun.altitude - OMNI_CORE.state.pitch)*10;
        
        this.ctx.strokeStyle = "#ffcc00";
        this.ctx.lineWidth = 2;
        this.ctx.beginPath();
        this.ctx.arc(x, y, 15, 0, Math.PI*2);
        this.ctx.moveTo(x-25, y); this.ctx.lineTo(x+25, y);
        this.ctx.moveTo(x, y-25); this.ctx.lineTo(x, y+25);
        this.ctx.stroke();
    },
    analyzeReality() {
        // Logique chromatique simplifiée pour la météo
        const clouds = Math.random() > 0.7 ? "ORAGEUX" : "STABLE";
        document.getElementById('statut-meteo').innerText = clouds;
    }
};

const OMNI_MAP = {
    map: null,
    init() {
        this.map = L.map('map', {zoomControl: false}).setView([48.8566, 2.3522], 14);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(this.map);
    }
};

document.getElementById('main-init-btn').addEventListener('click', () => OMNI_CORE.boot());
</script>
</body>
</html>
