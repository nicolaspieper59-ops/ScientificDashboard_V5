<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>V62 • ZERO_SIMULATION</title>
    <style>
        :root { --ion: #00ffcc; --bg: #000; --warn: #ff0055; }
        body { margin: 0; background: var(--bg); color: var(--ion); font-family: 'JetBrains Mono', monospace; font-size: 11px; overflow: hidden; }
        .hud { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; height: 100vh; grid-template-rows: auto 1fr auto; }
        .panel { border: 1px solid var(--ion); padding: 12px; background: rgba(5,10,10,0.95); position: relative; }
        .title { font-size: 0.7rem; font-weight: 900; letter-spacing: 2px; border-bottom: 1px solid var(--ion); margin-bottom: 8px; }
        .val { color: #fff; font-size: 1.4rem; font-variant-numeric: tabular-nums; }
        .unit { font-size: 0.6rem; opacity: 0.6; }
        canvas { width: 100%; height: 80px; background: #050505; margin-top: 10px; }
        #calib-overlay { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column; text-align: center; }
        .btn { background: var(--ion); color: #000; border: none; padding: 20px 40px; font-weight: 900; cursor: pointer; letter-spacing: 2px; }
        .status { font-size: 0.6rem; color: var(--warn); }
    </style>
</head>
<body>

<div id="calib-overlay">
    <h2 style="letter-spacing: 10px;">PROCÉDURE DE CALIBRAGE</h2>
    <p>Posez l'appareil sur une surface parfaitement stable.<br>Ne touchez plus à rien pendant 5 secondes.</p>
    <button class="btn" onclick="SENSOR.startCalibrate()">LANCER LA SYNCHRO</button>
</div>

<div class="hud">
    <div class="panel">
        <div class="title">ACCÉLÉROMÉTRIE BRUTE (m/s²)</div>
        <div>TOTAL_G: <span class="val" id="v-g">--</span></div>
        <div class="status" id="v-noise">BRUIT: ANALYSE EN COURS...</div>
        <canvas id="cv-raw"></canvas>
    </div>

    <div class="panel">
        <div class="title">ORIENTATION RÉELLE (DEG)</div>
        <div style="display: flex; gap: 10px;">
            <div>PITCH: <span class="val" id="v-p">0</span>°</div>
            <div>ROLL: <span class="val" id="v-r">0</span>°</div>
        </div>
        <div class="unit">Correction d'inclinaison active</div>
    </div>

    <div class="panel" style="grid-column: 1 / -1;">
        <div class="title">FLUX DE RÉALITÉ SOUVERAIN (128-bit Export Ready)</div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>VECTOR_ABS: <span class="val" id="v-abs" style="color: var(--ion);">0.00000000</span></div>
            <button class="btn" style="padding: 10px;" onclick="ARCHIVE.download()">EXPORT (.REAL)</button>
        </div>
    </div>
</div>

<script>
const SENSOR = {
    active: false,
    bias: 0,
    history: new Array(100).fill(0),
    log: [],

    async startCalibrate() {
        if (typeof DeviceMotionEvent.requestPermission === 'function') {
            await DeviceMotionEvent.requestPermission();
        }
        
        document.getElementById('calib-overlay').innerHTML = "<h1>SYNCHRO...</h1><p>Mesure du biais résiduel...</p>";
        
        let samples = [];
        const capture = (e) => {
            const acc = e.accelerationIncludingGravity;
            samples.push(Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2));
        };

        window.addEventListener('devicemotion', capture);
        
        setTimeout(() => {
            window.removeEventListener('devicemotion', capture);
            this.bias = samples.reduce((a, b) => a + b, 0) / samples.length - 9.80665;
            document.getElementById('calib-overlay').style.display = 'none';
            this.active = true;
            this.ignite();
        }, 5000);
    },

    ignite() {
        window.addEventListener('devicemotion', e => this.process(e));
        window.addEventListener('deviceorientation', e => {
            document.getElementById('v-p').innerText = Math.round(e.beta);
            document.getElementById('v-r').innerText = Math.round(e.gamma);
        });
        this.draw();
    },

    process(e) {
        if(!this.active) return;
        const acc = e.accelerationIncludingGravity;
        const raw = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
        
        // La seule opération : soustraire le biais matériel mesuré
        const real = raw - this.bias;
        
        this.history.push(real);
        this.history.shift();
        this.log.push({t: Date.now(), g: real});
        if(this.log.length > 5000) this.log.shift();

        document.getElementById('v-g').innerText = real.toFixed(5);
        document.getElementById('v-abs').innerText = real.toFixed(8);
        
        // Analyse du bruit (stabilité)
        const noise = Math.abs(real - 9.80665);
        document.getElementById('v-noise').innerText = `VARIANCE: ${noise.toFixed(6)}`;
    },

    draw() {
        const c = document.getElementById('cv-raw'), ctx = c.getContext('2d');
        const loop = () => {
            ctx.clearRect(0,0,c.width, c.height);
            ctx.strokeStyle = '#0ff'; ctx.lineWidth = 1;
            ctx.beginPath();
            this.history.forEach((v, i) => ctx.lineTo(i*(c.width/100), 40 + (v-9.8)*200));
            ctx.stroke();
            requestAnimationFrame(loop);
        };
        loop();
    }
};

const ARCHIVE = {
    download() {
        const blob = new Blob([JSON.stringify(SENSOR.log)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `VERITAS_${Date.now()}.REAL`;
        a.click();
    }
};
</script>
</body>
</html>
