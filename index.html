<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OMNISCIENCE V50 • PATHFINDER</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <style>
        :root { 
            --accent: #00ffcc; --bg: #020505; --glass: rgba(5, 12, 12, 0.95);
            --text: #ffffff; --transition: 0.5s ease;
        }

        body.night-mode { --accent: #ff9500; --bg: #080400; --glass: rgba(15, 8, 0, 0.95); }

        * { box-sizing: border-box; }
        body { 
            margin: 0; background: var(--bg); color: var(--accent); 
            font-family: 'Inter', monospace; overflow: hidden; height: 100vh;
        }

        #map { position: fixed; inset: 0; filter: contrast(1.1) brightness(0.3) grayscale(1) invert(1); z-index: 0; }

        .hud { 
            position: fixed; inset: 0; z-index: 100; pointer-events: none;
            padding: 20px; display: grid; grid-template-columns: 340px 1fr 340px; gap: 20px;
        }

        .panel { 
            pointer-events: auto; background: var(--glass); border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(25px);
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.8);
        }

        .title-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }
        .title { font-size: 0.7rem; font-weight: 900; letter-spacing: 3px; text-transform: uppercase; }

        .card { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; }
        .label { font-size: 0.6rem; opacity: 0.5; text-transform: uppercase; display: block; }
        .number { font-size: 1.2rem; font-weight: 700; color: #fff; font-family: 'JetBrains Mono'; }

        canvas { width: 100%; height: 80px; border-radius: 10px; margin-top: 5px; background: rgba(0,0,0,0.2); }

        #alert-hub { 
            grid-column: 2; align-self: start; justify-self: center;
            padding: 10px 25px; border-radius: 40px; background: var(--glass);
            border: 1px solid var(--accent); font-weight: 900; font-size: 0.7rem;
            letter-spacing: 2px; transition: var(--transition);
        }

        .btn-action { 
            pointer-events: auto; background: var(--accent); color: #000; 
            border: none; padding: 15px; border-radius: 12px;
            font-weight: 900; cursor: pointer; text-transform: uppercase;
        }

        #overlay { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="overlay"><button class="btn-action" style="padding: 30px 60px" onclick="CORE.ignite()">INITIALIZE PATHFINDER</button></div>

<div class="hud">
    <div class="panel">
        <div class="title-row"><span class="title">Quantum Gravity</span><span id="v-rate">0 Hz</span></div>
        <canvas id="cv-g"></canvas>
        <div class="card"><span class="label">Local Anomaly</span><span class="number" id="v-anom">0.000 mGal</span></div>
        <div class="card"><span class="label">Time Flux (Rel)</span><span class="number" id="v-time">0.00 ns</span></div>
    </div>

    <div id="alert-hub">CORE_READY</div>

    <div class="panel">
        <div class="title-row"><span class="title">Navigation Log</span><span id="v-coords">0.0, 0.0</span></div>
        <div id="log" style="font-size: 0.65rem; height: 180px; overflow-y: auto; opacity: 0.7; line-height: 1.5;">
            > System standby...
        </div>
        <button class="btn-action" onclick="CORE.toggleNight()">Toggle Night Spectrum</button>
    </div>
</div>

<script>
const CORE = {
    active: false, g_ref: 9.806, history: new Array(60).fill(0),
    lastT: performance.now(), drift: 0, currentAnom: 0,

    async ignite() {
        if (window.DeviceMotionEvent?.requestPermission) await DeviceMotionEvent.requestPermission();
        document.getElementById('overlay').style.display = 'none';
        
        this.log("Syncing with planetary rotation...");
        let samples = [];
        const cal = (e) => {
            const g = e.accelerationIncludingGravity;
            samples.push(Math.sqrt(g.x**2 + g.y**2 + g.z**2));
            if(samples.length > 40) {
                this.g_ref = samples.reduce((a,b)=>a+b)/samples.length;
                window.removeEventListener('devicemotion', cal);
                this.start();
            }
        };
        window.addEventListener('devicemotion', cal);
    },

    start() {
        this.active = true;
        window.addEventListener('devicemotion', e => this.physics(e));
        MAP_SYS.init();
        this.render();
    },

    physics(e) {
        if(!this.active) return;
        const now = performance.now();
        const dt = (now - this.lastT) / 1000;
        this.lastT = now;

        const g = e.accelerationIncludingGravity;
        const raw = Math.sqrt(g.x**2 + g.y**2 + g.z**2);
        this.currentAnom = (raw - this.g_ref) * 100000;
        
        this.history.push(this.currentAnom);
        this.history.shift();
        
        this.drift += (this.g_ref / 8.987e16) * 1e9 * dt;
        this.updateUI();
    },

    updateUI() {
        document.getElementById('v-anom').innerText = this.currentAnom.toFixed(3) + " mGal";
        document.getElementById('v-time').innerText = this.drift.toFixed(6) + " ns";
        
        const hub = document.getElementById('alert-hub');
        if(this.currentAnom < -100) {
            hub.innerText = "⚠ MASS_DEFICIT_DETECTED";
            hub.style.color = "#ff3300";
        } else {
            hub.innerText = "SIGNAL_STABLE";
            hub.style.color = "var(--accent)";
        }
    },

    log(m) {
        const l = document.getElementById('log');
        l.innerHTML = `> ${m}<br>` + l.innerHTML;
    },

    toggleNight() { document.body.classList.toggle('night-mode'); },

    render() {
        const cv = document.getElementById('cv-g'), ctx = cv.getContext('2d');
        const loop = () => {
            ctx.clearRect(0,0,cv.width, cv.height);
            ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--accent');
            ctx.lineWidth = 2; ctx.beginPath();
            this.history.forEach((v, i) => ctx.lineTo(i*(cv.width/60), 40 + v*0.4));
            ctx.stroke();
            requestAnimationFrame(loop);
        };
        loop();
    }
};

const MAP_SYS = {
    map: null, path: null,
    init() {
        this.map = L.map('map', {zoomControl: false, attributionControl: false}).setView([43.29, 5.37], 17);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(this.map);
        
        navigator.geolocation.watchPosition(p => {
            const pos = [p.coords.latitude, p.coords.longitude];
            this.map.panTo(pos);
            document.getElementById('v-coords').innerText = p.coords.latitude.toFixed(4) + ", " + p.coords.longitude.toFixed(4);
            
            // Heatmap Tracking: Couleur selon l'anomalie
            const color = CORE.currentAnom < -80 ? '#ff3300' : (CORE.currentAnom > 80 ? '#00ffcc' : '#3366ff');
            L.circle(pos, {radius: 2, color: color, fillOpacity: 0.8}).addTo(this.map);
        }, null, {enableHighAccuracy: true});
    }
};
</script>
</body>
</html>
