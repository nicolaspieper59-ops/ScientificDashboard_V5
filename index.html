<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROVIDENCE V19-S | VISION ABSOLUE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <style>
        :root { --glow: #00ff88; --bg: #050705; --border: #004422; }
        body { background: var(--bg); color: #e0ffe0; font-family: 'JetBrains Mono', monospace; margin: 0; overflow: hidden; }
        .hud { display: grid; grid-template-columns: 300px 1fr 300px; height: 100vh; padding: 10px; gap: 10px; }
        .panel { border: 1px solid var(--border); padding: 15px; background: rgba(5,10,5,0.9); }
        .v-main { font-size: 3rem; color: var(--glow); text-align: center; font-family: 'Orbitron', sans-serif; }
        #cam-layer { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; opacity: 0.3; z-index: -1; }
        #slam-canvas { width: 100%; height: 300px; border: 1px solid var(--border); margin-top: 10px; }
        button { background: var(--glow); border: none; padding: 20px; width: 100%; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<video id="cam-layer" autoplay playsinline muted></video>

<div class="hud">
    <aside class="panel">
        <h3>[FLUX_OPTIQUE]</h3>
        <div id="ui-mode">MODE: SEXTANT_STELLARUM</div>
        <div id="ui-features">POINTS_SUIVIS: 0</div>
        <hr border-color="#004422">
        <div id="log" style="font-size: 0.7rem; color: #ffcc00;">> ATTENTE_SIGNAL_OPTIQUE</div>
    </aside>

    <main class="panel">
        <div class="v-main" id="ui-speed">0.000000</div>
        <div style="text-align:center; font-size:0.7rem;">VITESSE_RÉELLE (M/S)</div>
        <canvas id="slam-canvas"></canvas>
        <div id="ui-coord" style="font-size:0.8rem; margin-top:10px; word-break:break-all;">X: 0.000000000000000000000000</div>
    </main>

    <aside class="panel">
        <button id="start-btn" onclick="KERNEL.init()">ACTIVER_NAVIGATION_VISUELLE</button>
        <div style="margin-top:20px;">
            <h4>[ÉTAT_MILIEU]</h4>
            <div>DENSITÉ: 1.225 kg/m³</div>
            <div>COHÉRENCE: <span style="color:var(--glow)">VÉRIFIÉE</span></div>
        </div>
    </aside>
</div>

<script>
const KERNEL = {
    state: { active: false, lastPixels: null, v: 0, pos: math.bignumber(0) },
    
    async init() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        document.getElementById('cam-layer').srcObject = stream;
        document.getElementById('start-btn').style.display = 'none';
        this.state.active = true;
        this.setupCanvas();
        this.process();
    },

    setupCanvas() {
        this.canvas = document.getElementById('slam-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.video = document.getElementById('cam-layer');
    },

    process() {
        if(!this.state.active) return;
        
        // 1. Capture du décor / astres
        this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
        const frame = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
        
        if (this.state.lastPixels) {
            // 2. Calcul du différentiel (Optical Flow simplifié)
            // On compare la luminosité moyenne des zones pour détecter le mouvement
            let motion = this.calculateMotion(this.state.lastPixels, frame.data);
            
            // 3. Conversion Pixel -> Réalité (Sextant)
            // On applique un facteur de correction selon le milieu (Grotte vs Espace)
            this.state.v = motion * 0.05; // Calibration arbitraire (m/s)
            this.state.pos = math.add(this.state.pos, math.multiply(this.state.v, 0.016));
        }

        this.state.lastPixels = frame.data;
        this.updateUI();
        requestAnimationFrame(() => this.process());
    },

    calculateMotion(prev, curr) {
        let diff = 0;
        let points = 0;
        // On scanne un point sur 100 pour la performance (Rigueur NASA)
        for (let i = 0; i < curr.length; i += 400) {
            diff += Math.abs(curr[i] - prev[i]);
            if(curr[i] > 200) points++; // Détection de "points d'intérêt" (astres/néons)
        }
        document.getElementById('ui-features').innerText = "POINTS_SUIVIS: " + points;
        return diff / 100000;
    },

    updateUI() {
        document.getElementById('ui-speed').innerText = this.state.v.toFixed(6);
        document.getElementById('ui-coord').innerText = "X: " + math.format(this.state.pos, {notation: 'fixed', precision: 24});
    }
};
</script>
</body>
                                                                                  </html>
