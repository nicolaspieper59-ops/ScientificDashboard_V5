<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCHÈ V8000 | SINGULARITY</title>
    <style>
        :root { --blue: #00d4ff; --red: #ff4444; --green: #00ff88; --orange: #ffaa00; --bg: #020202; }
        body { background: var(--bg); color: white; font-family: 'Consolas', monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* HUD & MATRICE */
        #hud { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; padding: 10px; flex: 1; }
        .card { background: #08080a; border: 1px solid #1a1a1c; padding: 12px; display: flex; flex-direction: column; position: relative; }
        .label { font-size: 0.6rem; color: #555; text-transform: uppercase; letter-spacing: 1px; }
        .val { font-size: 2.2rem; color: var(--blue); font-weight: bold; }
        
        #state-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; background: #000; padding: 5px; height: 120px; }
        .state-led { font-size: 0.5rem; background: #0a0a0a; color: #222; display: flex; align-items: center; justify-content: center; text-align: center; border: 1px solid #111; text-transform: uppercase; }
        .state-led.on { background: #002233; color: var(--blue); border-color: var(--blue); box-shadow: inset 0 0 5px var(--blue); }
        .state-led.alert { background: #330000; color: var(--red); border-color: var(--red); }

        /* OSCILLOSCOPE & SONAR */
        #visuals { height: 100px; display: grid; grid-template-columns: 1fr 1fr; gap: 2px; border-top: 1px solid #222; }
        canvas { width: 100%; height: 100%; background: #000; }
        
        #terminal { height: 15vh; background: #000; border-top: 1px solid #222; padding: 8px; font-size: 0.65rem; overflow-y: auto; color: #0f0; }
        
        /* OVERLAYS */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #camera-vox { position: absolute; top: 5px; right: 5px; width: 80px; height: 45px; border: 1px solid #333; opacity: 0.5; object-fit: cover; pointer-events: none; }
        
        .btn-main { background: none; border: 1px solid var(--blue); color: var(--blue); padding: 20px 40px; cursor: pointer; font-family: inherit; }
    </style>
</head>
<body>

<div id="overlay">
    <div id="calib-status">SYSTÈME PRÊT : SOUVERAINETÉ TOTALE</div>
    <div style="width:200px; height:2px; background:#111; margin: 20px 0;"><div id="loader" style="width:0%; height:100%; background:var(--blue)"></div></div>
    <button class="btn-main" onclick="startCalibration()">LANCER CALIBRATION</button>
</div>

<video id="camera-vox" autoplay playsinline></video>

<div id="hud">
    <div class="card">
        <div class="label">Vérité Inertielle (m/s)</div>
        <div id="v-val" class="val">0.00</div>
        <div id="vector-dir" style="font-size:0.6rem; color:var(--orange)">AXE NEUTRE</div>
    </div>
    <div class="card">
        <div class="label">Vecteur Gravité (G)</div>
        <div id="g-val" class="val">1.00</div>
    </div>
</div>

<div id="state-grid"></div>

<div id="visuals">
    <canvas id="oscillo"></canvas>
    <canvas id="sonar"></canvas>
</div>

<div id="terminal"></div>

<script>
    // --- CONFIGURATION MÉTROLOGIQUE ---
    const STATES = [
        "ACCEL", "DECEL", "CONST", "STILL", 
        "FREEFALL", "G-LOAD", "LIGHT", "IMPACT",
        "ROLL-L", "ROLL-R", "PITCH", "SPIN",
        "NOISE", "RESO", "SHOCK", "VIBE",
        "DRIFT", "FRIC", "LOCK", "BOUNCE",
        "SATUR", "LOSS", "CALIB", "SLEEP"
    ];

    let state = { 
        v: 0, bias: 0, lastT: performance.now(), 
        isCalibrated: false, motion: 0,
        historyA: [], blackBox: [] 
    };
    
    let canvasO, ctxO, canvasS, ctxS, audio, analyser, dataArray, prevFrame;

    // --- 1. INITIALISATION & CALIBRATION ---
    function initGrid() {
        const grid = document.getElementById('state-grid');
        STATES.forEach(s => {
            let div = document.createElement('div');
            div.className = 'state-led';
            div.id = 'state-' + s;
            div.innerText = s;
            grid.appendChild(div);
        });
    }

    async function startCalibration() {
        initGrid();
        const btn = document.querySelector('.btn-main');
        btn.style.display = 'none';
        
        let samples = [];
        let count = 0;
        
        // Démarrage Vidéo Voxel
        const video = document.getElementById('camera-vox');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            video.srcObject = stream;
            startVoxelProcessor(video);
        } catch(e) { log("Voxel : Capteur visuel non disponible."); }

        const calibLoop = setInterval(() => {
            count++;
            document.getElementById('loader').style.width = (count * 2) + "%";
            document.getElementById('calib-status').innerText = "MESURE DU BRUIT THERMIQUE...";
            
            if(count >= 50) {
                clearInterval(calibLoop);
                state.bias = samples.reduce((a,b)=>a+b, 0) / samples.length;
                state.isCalibrated = true;
                document.getElementById('overlay').style.display = 'none';
                log(`Calibration OK. Biais soustrait : ${state.bias.toFixed(4)} m/s²`);
                bootEngine();
            }
        }, 100);

        window.addEventListener('devicemotion', (e) => {
            if(!state.isCalibrated) {
                let a = e.acceleration;
                if(a) samples.push(Math.sqrt(a.x**2 + a.y**2 + a.z**2));
            }
        });
    }

    // --- 2. MOTEUR DE VÉRITÉ (VECTORIEL & INERTIEL) ---
    function bootEngine() {
        canvasO = document.getElementById('oscillo');
        ctxO = canvasO.getContext('2d');
        
        window.addEventListener('devicemotion', (e) => {
            const now = performance.now();
            const dt = Math.min((now - state.lastT) / 1000, 0.1);
            state.lastT = now;

            const acc = e.acceleration;
            const gAcc = e.accelerationIncludingGravity;
            const rot = e.rotationRate;
            
            let activeStates = new Set();

            // --- ANALYSE VECTORIELLE (AXE Y S10e) ---
            let aRaw = acc ? acc.y : 0;
            let aCorrected = (Math.abs(aRaw) < state.bias * 1.5) ? 0 : aRaw;

            // LOI D'INERTIE & ANTI-ILLUSION
            const isVisualMoving = state.motion > 15;
            
            if (aCorrected !== 0) {
                if(aCorrected > 0) activeStates.add("ACCEL");
                else activeStates.add("DECEL");
                state.v += aCorrected * dt;
            } else if (state.v > 0.05) {
                // INERTIE : La vitesse tient !
                activeStates.add("CONST");
                state.v *= (isVisualMoving ? 0.999 : 0.98); // Moins de friction si confirmé par Voxel
            } else {
                activeStates.add("STILL");
                state.v = 0;
            }

            // --- ANALYSE GRAVITÉ ---
            if(gAcc) {
                let g = Math.sqrt(gAcc.x**2 + gAcc.y**2 + gAcc.z**2) / 9.81;
                document.getElementById('g-val').innerText = g.toFixed(2);
                if(g < 0.2) activeStates.add("FREEFALL");
                if(g > 1.5) activeStates.add("G-LOAD");
            }

            // --- GESTION DES 24 ÉTATS & UI ---
            updateStatesUI(activeStates);
            state.v = Math.max(0, state.v);
            document.getElementById('v-val').innerText = state.v.toFixed(2);
            
            state.historyA.push(aCorrected);
            if(state.historyA.length > 100) state.historyA.shift();
            drawOscillo();
        });
    }

    // --- 3. VOXEL-PROXY & SONAR (SANS TRICHE) ---
    function startVoxelProcessor(video) {
        const vCanvas = document.createElement('canvas');
        const vCtx = vCanvas.getContext('2d');
        setInterval(() => {
            if(!video.videoWidth) return;
            vCanvas.width = 32; vCanvas.height = 32;
            vCtx.drawImage(video, 0, 0, 32, 32);
            const data = vCtx.getImageData(0, 0, 32, 32).data;
            if(prevFrame) {
                let diff = 0;
                for(let i=0; i<data.length; i+=4) diff += Math.abs(data[i] - prevFrame[i]);
                state.motion = diff / 500;
            }
            prevFrame = data;
        }, 150);
    }

    async function toggleSonar() {
        // Optionnel : Automatisé au boot si nécessaire
        audio = new (window.AudioContext || window.webkitAudioContext)();
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const source = audio.createMediaStreamSource(stream);
        analyser = audio.createAnalyser();
        analyser.fftSize = 64;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        source.connect(analyser);
        renderSonar();
    }

    // --- VISUALISATION ---
    function drawOscillo() {
        ctxO.clearRect(0,0,canvasO.width, canvasO.height);
        ctxO.beginPath();
        ctxO.strokeStyle = varColor();
        let step = canvasO.width / 100;
        for(let i=0; i<state.historyA.length; i++){
            let x = i*step;
            let y = (canvasO.height/2) - (state.historyA[i]*15);
            if(i==0) ctxO.moveTo(x,y); else ctxO.lineTo(x,y);
        }
        ctxO.stroke();
    }

    function renderSonar() {
        requestAnimationFrame(renderSonar);
        if(!analyser) return;
        analyser.getByteFrequencyData(dataArray);
        ctxS = document.getElementById('sonar').getContext('2d');
        ctxS.fillStyle = 'rgba(0,0,0,0.2)';
        ctxS.fillRect(0,0,300,150);
        dataArray.forEach((v, i) => {
            ctxS.fillStyle = `rgb(0, ${v+50}, 255)`;
            ctxS.fillRect(i*10, 100-v/3, 8, v/3);
        });
    }

    function updateStatesUI(activeSet) {
        STATES.forEach(s => {
            const el = document.getElementById('state-' + s);
            if(activeSet.has(s)) el.classList.add('on');
            else el.classList.remove('on');
        });
    }

    function varColor() {
        let last = state.historyA[state.historyA.length-1];
        return last > 0 ? '#ff4444' : (last < 0 ? '#00d4ff' : '#555');
    }

    function log(m) {
        const t = document.getElementById('terminal');
        t.innerHTML = `<div>> ${m}</div>` + t.innerHTML;
        t.scrollTop = 0;
    }

    window.onload = () => { if(confirm("Activer le SONAR Spectral ?")) toggleSonar(); };
</script>
</body>
    </html>
