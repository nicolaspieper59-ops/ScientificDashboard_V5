<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OMNISCIENCE V31 • FINAL_REALITY</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <style>
        :root { --neon: #00ff88; --alert: #ff3300; --void: #000000; --hud: rgba(0, 20, 10, 0.85); }
        body { margin: 0; background: var(--void); color: var(--neon); font-family: 'Courier New', monospace; overflow: hidden; height: 100vh; user-select: none; }
        
        /* COUCHES VISUELLES */
        #map { position: fixed; inset: 0; filter: grayscale(1) invert(1) brightness(0.4); z-index: 0; }
        #radar-layer { position: fixed; inset: 0; z-index: 10; pointer-events: none; }
        
        /* HUD SCIENTIFIQUE */
        .hud-container { position: fixed; inset: 0; z-index: 20; pointer-events: none; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; }
        
        .panel { pointer-events: auto; background: var(--hud); border: 1px solid var(--neon); padding: 10px; backdrop-filter: blur(4px); margin-bottom: 10px; box-shadow: 0 0 15px rgba(0, 255, 136, 0.2); }
        
        .row { display: flex; justify-content: space-between; font-size: 0.7rem; border-bottom: 1px solid #333; padding: 4px 0; }
        .val { font-weight: bold; color: #fff; }
        .warn { color: var(--alert); animation: pulse 0.5s infinite; }
        
        /* SPECTRE AUDIO VISUEL */
        .spectrum { display: flex; align-items: flex-end; height: 30px; gap: 1px; margin-top: 5px; opacity: 0.8; }
        .bar { width: 100%; background: var(--neon); transition: height 0.05s; }
        
        /* BOUTON D'ACTION */
        #btn-main { width: 100%; background: transparent; border: 1px solid var(--neon); color: var(--neon); padding: 15px; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; transition: 0.3s; }
        #btn-main:hover { background: var(--neon); color: black; }
        #btn-main.active { background: var(--alert); border-color: var(--alert); color: white; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        #scan-line { position: fixed; top: 50%; left: 0; right: 0; height: 2px; background: rgba(0, 255, 136, 0.5); box-shadow: 0 0 10px var(--neon); animation: scan 3s infinite linear; pointer-events: none; z-index: 5; }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
    </style>
</head>
<body>

<div id="map"></div>
<canvas id="radar-layer"></canvas>
<div id="scan-line"></div>

<div class="hud-container">
    <div class="panel" style="width: 280px;">
        <div style="font-size: 1.2rem; border-bottom: 2px solid var(--neon); margin-bottom: 5px;" id="mode-display">INITIALISATION...</div>
        <div class="row"><span>GRAVITÉ LOCALE</span><span class="val" id="v-g">9.8066</span></div>
        <div class="row"><span>CORIOLIS (Lat)</span><span class="val" id="v-cor">0.0000</span></div>
        <div class="row"><span>LORENTZ (Temps)</span><span class="val" id="v-lor">1.00000000</span></div>
        <div class="row"><span>REYNOLDS (Fluide)</span><span class="val" id="v-re">0</span></div>
        <div class="row"><span>ANOMALIE_BOUGUER</span><span class="val" id="v-anom">STABLE</span></div>
    </div>

    <div class="panel" style="align-self: flex-end; width: 200px;">
        <div class="row"><span>ACOUSTIQUE</span><span class="val" id="v-db">0 dB</span></div>
        <div class="spectrum" id="audio-viz">
            </div>
        <div class="row" style="margin-top:5px;"><span>SISMICITÉ</span><span class="val" id="v-seis">NÉANT</span></div>
    </div>

    <div class="panel">
        <div class="row" style="margin-bottom: 10px;">
            <span>COORDONNÉES ABSOLUES (ITRF2020)</span>
            <span class="val" id="v-coords">43.296500 | 5.369800</span>
        </div>
        <button id="btn-main" onclick="CORE.toggleMission()">ACTIVER BOÎTE NOIRE SOUVERAINE</button>
    </div>
</div>

<script>
/**
 * OMNISCIENCE V31 : NOYAU COMPLET
 */
const CORE = {
    recording: false,
    db: null,
    audioCtx: null,
    analyser: null,
    
    state: {
        lat: 43.2965, lon: 5.3698,
        vel: {x:0, y:0, z:0},
        g: 9.81,
        startTime: Date.now()
    },

    async init() {
        // 1. Initialisation Base de Données (IndexedDB)
        const request = indexedDB.open("OmniscienceBox", 1);
        request.onupgradeneeded = e => {
            e.target.result.createObjectStore("telemetry", { autoIncrement: true });
        };
        request.onsuccess = e => { this.db = e.target.result; console.log("DB_LOCKED"); };

        // 2. Initialisation Capteurs
        try {
            if (typeof DeviceMotionEvent.requestPermission === 'function') await DeviceMotionEvent.requestPermission();
            window.addEventListener('devicemotion', e => this.physicsEngine(e));
            this.initAudio();
        } catch(e) { 
            console.warn("Mode Simulation Activé"); 
            this.simulateChaos(); // Fallback si pas de capteurs
        }

        // 3. Initialisation Graphique
        RADAR.init();
        this.loop();
        MAP_SYS.init();
    },

    physicsEngine(e) {
        const acc = e.accelerationIncludingGravity;
        const pureAcc = e.acceleration;
        
        // Calcul Scientifique Réel
        const latRad = this.state.lat * Math.PI / 180;
        
        // A. Gravité de Somigliana
        const gLoc = 9.780327 * (1 + 0.0053024 * Math.sin(latRad)**2 - 0.0000058 * Math.sin(2*latRad)**2);
        
        // B. Force de Coriolis
        const velMag = Math.sqrt(this.state.vel.x**2 + this.state.vel.y**2);
        const coriolis = 2 * 7.2921e-5 * velMag * Math.sin(latRad);
        
        // C. Facteur de Lorentz (Relativité)
        const c = 299792458;
        const lorentz = 1 / Math.sqrt(1 - (velMag**2 / c**2));

        // D. Nombre de Reynolds (Estimation Air/Eau)
        const density = this.state.underwater ? 1000 : 1.225;
        const reynolds = (density * velMag * 0.5) / 0.000018; // Viscosité dyn approx

        // Mise à jour UI
        this.updateHUD(gLoc, coriolis, lorentz, reynolds, acc);

        // Enregistrement Boîte Noire
        if(this.recording) this.savePacket(gLoc, acc, lorentz);
    },

    updateHUD(g, cor, lor, re, acc) {
        document.getElementById('v-g').innerText = g.toFixed(5);
        document.getElementById('v-cor').innerText = cor.toFixed(6);
        document.getElementById('v-lor').innerText = lor.toFixed(10);
        document.getElementById('v-re').innerText = re.toFixed(0);
        
        // Détection de Mode
        const totalG = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2) / 9.81;
        let mode = "OBSERVATION";
        if(totalG > 2.5) mode = "WAGONNET/VIRAGE";
        if(totalG < 0.2) mode = "CHUTE/ORBITE";
        if(re > 100000) mode = "HAUTE VITESSE";
        document.getElementById('mode-display').innerText = mode;
        
        if(mode.includes("WAGONNET")) document.getElementById('mode-display').classList.add('warn');
        else document.getElementById('mode-display').classList.remove('warn');
    },

    async initAudio() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            this.audioCtx = new AudioContext();
            this.analyser = this.audioCtx.createAnalyser();
            this.analyser.fftSize = 64;
            const src = this.audioCtx.createMediaStreamSource(stream);
            src.connect(this.analyser);
            this.buildSpectrumUI();
        } catch(e) { console.log("Audio non disponible"); }
    },

    buildSpectrumUI() {
        const container = document.getElementById('audio-viz');
        for(let i=0; i<32; i++) {
            const bar = document.createElement('div');
            bar.className = 'bar';
            container.appendChild(bar);
        }
    },

    updateAudioViz() {
        if(!this.analyser) return;
        const data = new Uint8Array(this.analyser.frequencyBinCount);
        this.analyser.getByteFrequencyData(data);
        
        const bars = document.querySelectorAll('.spectrum .bar');
        let sum = 0;
        bars.forEach((bar, i) => {
            const h = (data[i] / 255) * 100;
            bar.style.height = h + '%';
            bar.style.backgroundColor = h > 80 ? '#ff3300' : '#00ff88';
            sum += data[i];
        });
        
        const avg = sum / data.length;
        document.getElementById('v-db').innerText = avg.toFixed(1) + " dB";
        
        // Détection sismico-acoustique
        const seis = document.getElementById('v-seis');
        if(avg > 100) { seis.innerText = "CHOC DÉTECTÉ"; seis.classList.add('warn'); }
        else { seis.innerText = "CALME"; seis.classList.remove('warn'); }
    },

    savePacket(g, acc, lor) {
        if(!this.db) return;
        const tx = this.db.transaction("telemetry", "readwrite");
        tx.objectStore("telemetry").add({
            t: performance.now(),
            g: g,
            acc: {x: acc.x, y: acc.y, z: acc.z},
            relativity: lor
        });
    },

    toggleMission() {
        this.recording = !this.recording;
        const btn = document.getElementById('btn-main');
        if(this.recording) {
            this.init(); // Force re-init sensors
            btn.innerText = "ENREGISTREMENT SOUVERAIN [REC]";
            btn.classList.add('active');
        } else {
            btn.innerText = "MISSION TERMINÉE (SAUVEGARDÉE)";
            btn.classList.remove('active');
        }
    },

    loop() {
        requestAnimationFrame(() => this.loop());
        this.updateAudioViz();
        RADAR.draw();
    },

    simulateChaos() {
        // Pour tester l'interface sans bouger le PC
        setInterval(() => {
            const fakeAcc = {
                x: (Math.random()-0.5)*20,
                y: (Math.random()-0.5)*20,
                z: 9.81 + (Math.random()-0.5)*5
            };
            this.physicsEngine({accelerationIncludingGravity: fakeAcc, acceleration: fakeAcc});
        }, 100);
    }
};

/**
 * MODULE RADAR HOLOGRAPHIQUE
 */
const RADAR = {
    cvs: null, ctx: null, angle: 0,
    init() {
        this.cvs = document.getElementById('radar-layer');
        this.ctx = this.cvs.getContext('2d');
        this.resize();
        window.addEventListener('resize', () => this.resize());
    },
    resize() {
        this.cvs.width = window.innerWidth;
        this.cvs.height = window.innerHeight;
    },
    draw() {
        const w = this.cvs.width, h = this.cvs.height;
        const cx = w/2, cy = h/2;
        this.ctx.clearRect(0, 0, w, h);
        
        // Grille polaire
        this.ctx.strokeStyle = 'rgba(0, 255, 136, 0.1)';
        this.ctx.beginPath();
        this.ctx.arc(cx, cy, 100, 0, Math.PI*2);
        this.ctx.arc(cx, cy, 200, 0, Math.PI*2);
        this.ctx.arc(cx, cy, 300, 0, Math.PI*2);
        this.ctx.moveTo(cx-300, cy); this.ctx.lineTo(cx+300, cy);
        this.ctx.moveTo(cx, cy-300); this.ctx.lineTo(cx, cy+300);
        this.ctx.stroke();

        // Balayage Doppler
        this.angle += 0.02;
        this.ctx.save();
        this.ctx.translate(cx, cy);
        this.ctx.rotate(this.angle);
        
        const grad = this.ctx.createLinearGradient(0, 0, 300, 0);
        grad.addColorStop(0, 'rgba(0, 255, 136, 0)');
        grad.addColorStop(1, 'rgba(0, 255, 136, 0.5)');
        
        this.ctx.fillStyle = grad;
        this.ctx.beginPath();
        this.ctx.moveTo(0,0);
        this.ctx.arc(0, 0, 300, -0.2, 0.2);
        this.ctx.fill();
        this.ctx.restore();

        // Anomalies simulées (Points Rouges)
        if(Math.random() > 0.95) {
            this.ctx.fillStyle = '#ff3300';
            const rx = cx + (Math.random()-0.5)*400;
            const ry = cy + (Math.random()-0.5)*400;
            this.ctx.fillRect(rx, ry, 4, 4);
        }
    }
};

const MAP_SYS = {
    init() {
        const map = L.map('map', {zoomControl: false, attributionControl: false}).setView([43.2965, 5.3698], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    }
};

// Auto-start simulation si clic
document.addEventListener('click', () => { if(!CORE.db) CORE.init(); }, {once: true});

</script>
</body>
                </html>
