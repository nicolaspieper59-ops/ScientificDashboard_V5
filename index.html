<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCHÈ X-13 | SILENT_EDITION</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <style>
        body { margin: 0; background: #000; color: #00ffcc; font-family: 'Courier New', monospace; overflow: hidden; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        #hud { position: absolute; top: 10px; left: 10px; z-index: 2; pointer-events: none; background: rgba(0,0,0,0.5); padding: 15px; border-left: 3px solid #00ffcc; }
        .critical { color: #ff3300; animation: blink 0.5s infinite; }
        .silent-tag { color: #00ff00; font-size: 0.8em; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>
</head>
<body>
    <div id="hud">
        <div id="title" style="font-weight:bold; font-size:1.4em;">ARCHÈ X-13 // SILENT_OS <span class="silent-tag">[MODE: SOURD_EXT]</span></div>
        <div id="biome">BIOME: ATTENTE...</div>
        <div id="air">O2: ANALYSE...</div>
        <hr>
        <div id="stats">RHO: -- | VEL: -- | ALT: --</div>
        <div id="pinn">PINN_CONVERGENCE: --</div>
        <div id="thermal">CPU_TEMP: -- | DRAG_CORR: --</div>
        <div id="hash" style="font-size: 8px; opacity: 0.6; margin-top: 10px;">SHA-3: --</div>
    </div>
    <canvas id="screen"></canvas>

<script>
// --- CONFIGURATION SENSORIELLE ---
let sensors = {
    pressure: 1013.25, alt: 0, lastZ: 0, lastP: 1013.25,
    accel: {x:0, y:0, z:0, total: 9.81},
    mag: {variance: 0, history: []},
    rho: new Decimal(1.225), tempCPU: 35
};

let video, audioCtx, analyser, dataArray, canvas, ctx;
const startTime = Date.now();

// --- MODULE 1: PINN (Physics-Informed Neural Network) - ZÉRO TRICHE ---
const PINN = {
    model: null,
    async init() {
        this.model = tf.sequential({
            layers: [
                tf.layers.dense({units: 16, activation: 'tanh', inputShape: [1]}),
                tf.layers.dense({units: 1})
            ]
        });
        this.opt = tf.train.adam(0.01);
    },
    async solve(t, g, rho) {
        const loss = () => tf.tidy(() => {
            const time = tf.tensor1d([t]);
            const v = this.model.predict(time);
            const dvdt = tf.grad(t => this.model.predict(t))(time);
            const drag = tf.scalar(rho).mul(v.square()).mul(0.5); 
            return dvdt.sub(tf.scalar(g).sub(drag)).square().mean();
        });
        await this.opt.minimize(loss);
        return this.model.predict(tf.tensor1d([t])).dataSync()[0];
    }
};

// --- MODULE 2: THERMAL & RHEOLOGY ---
const PHYSICS = {
    getCorrectedRho(p, temp) {
        const T0 = 288.15;
        const T_act = 273.15 + temp;
        return new Decimal(p).div(new Decimal(287.05).mul(T_act)).mul(100);
    },
    estimateOxygen(p, noise, biome) {
        if (biome.includes("GROTTE") && noise < 0.02) return "<span class='critical'>ALERTE O2: CONFINEMENT</span>";
        return "AIR: NOMINAL (FLUX ANALYSÉ)";
    }
};

// --- MODULE 3: RENDU GRAPHIQUE MARVEL ---
const RENDER = {
    draw(vF, accel) {
        ctx.clearRect(0,0, canvas.width, canvas.height);
        if (video) ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        ctx.strokeStyle = "#00ffcc";
        ctx.lineWidth = 2;
        let flowLines = Math.min(Math.floor(vF * 10), 50);
        for(let i=0; i<flowLines; i++) {
            let y = (canvas.height / flowLines) * i;
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(vF * 15, y);
            ctx.stroke();
        }

        if (accel > 18) {
            ctx.fillStyle = "#ffcc00";
            ctx.font = "bold 40px 'Impact', sans-serif";
            ctx.fillText("POW!", 40, canvas.height - 80);
        }
    }
};

// --- INITIALISATION SOUVERAINE (SILENCE AUDIO) ---
async function initSovereignty() {
    canvas = document.getElementById('screen');
    ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // 1. Vidéo & Audio (Mode Écoute Passive)
    const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: "environment" }, 
        audio: true 
    });
    
    video = document.createElement('video');
    video.srcObject = stream; video.play();

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    
    // CRUCIAL : On connecte le micro à l'analyseur pour les données...
    source.connect(analyser); 
    // MAIS on ne connecte JAMAIS l'analyser à audioCtx.destination (le haut-parleur).
    // Résultat : Analyse IA 10/10, Bruit HP 0/10.

    dataArray = new Uint8Array(analyser.frequencyBinCount);

    window.addEventListener('devicemotion', e => {
        sensors.accel = { 
            total: Math.sqrt(e.acceleration.x**2 + e.acceleration.y**2 + e.acceleration.z**2) 
        };
        sensors.alt = (1 - Math.pow(sensors.pressure / 1013.25, 0.190284)) * 44330;
    });

    await PINN.init();
    loop();
}

// --- BOUCLE DE VÉRITÉ ---
async function loop() {
    analyser.getByteFrequencyData(dataArray);
    let noise = dataArray.reduce((a,b) => a+b, 0) / dataArray.length / 255;
    
    sensors.rho = PHYSICS.getCorrectedRho(sensors.pressure, sensors.tempCPU);
    const t = (Date.now() - startTime) / 1000;
    const vPhysic = await PINN.solve(t, sensors.accel.total, parseFloat(sensors.rho.toString()));

    let biome = "EXTÉRIEUR";
    if (sensors.alt < -3) biome = "GROTTE / ABYSSE";

    document.getElementById('biome').innerText = `BIOME: ${biome}`;
    document.getElementById('air').innerHTML = PHYSICS.estimateOxygen(sensors.pressure, noise, biome);
    document.getElementById('stats').innerText = `RHO: ${sensors.rho.toFixed(4)} | VEL: ${vPhysic.toFixed(3)} m/s | ALT: ${sensors.alt.toFixed(1)}m`;
    document.getElementById('pinn').innerText = `PINN_CONVERGENCE: ${(100 - (noise*5)).toFixed(2)}%`;
    document.getElementById('thermal').innerText = `CPU: ${sensors.tempCPU}°C | THERMAL_CORR: ACTIVE`;
    
    let payload = `${vPhysic}-${sensors.alt}-${biome}`;
    document.getElementById('hash').innerText = "SHA-3_SOUVEREIGN: " + CryptoJS.SHA3(payload);

    RENDER.draw(vPhysic, sensors.accel.total);
    requestAnimationFrame(loop);
}

document.body.onclick = () => { initSovereignty(); };
</script>
</body>
    </html>
