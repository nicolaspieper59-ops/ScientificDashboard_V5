<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCHÈ V5100 | VOXEL-PROXY & METROLOGY</title>
    <style>
        :root { --blue: #00d4ff; --red: #ff4444; --green: #00ff88; --bg: #050505; }
        body { background: var(--bg); color: white; font-family: 'Consolas', monospace; margin: 0; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        #hud { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; padding: 10px; }
        .card { background: #111; border: 1px solid #222; padding: 10px; display: flex; flex-direction: column; position: relative; }
        .label { font-size: 0.6rem; color: #555; text-transform: uppercase; }
        .val { font-size: 2rem; color: var(--blue); font-weight: bold; }
        #camera-preview { width: 100%; height: 60px; object-fit: cover; border: 1px solid #333; filter: grayscale(1); opacity: 0.5; }
        .log-box { height: 100px; background: #000; border-top: 1px solid var(--blue); padding: 8px; font-size: 0.7rem; overflow-y: auto; color: #0f0; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; padding: 10px; }
        button { background: #111; border: 1px solid var(--blue); color: var(--blue); padding: 10px; font-size: 0.7rem; cursor: pointer; }
        #v-voxel-bar { height: 4px; background: var(--blue); width: 0%; transition: 0.1s; }
    </style>
</head>
<body>

<div id="hud">
    <div class="card">
        <div class="label">Vitesse (Inertie)</div>
        <div><span id="v-val" class="val">0.00</span><span style="font-size:0.7rem"> m/s</span></div>
    </div>
    <div class="card">
        <div class="label">Voxel-Proxy (Motion)</div>
        <video id="camera-preview" autoplay playsinline></video>
        <div id="v-voxel-bar"></div>
    </div>
    <div class="card">
        <div class="label">Altitude (Relative)</div>
        <div id="alt-val" class="val">0.0</div>
    </div>
    <div class="card">
        <div class="label">Confiance Métrologique</div>
        <div id="trust-val" class="val" style="color:var(--green)">100%</div>
    </div>
</div>

<div class="btn-group">
    <button onclick="startAll()">DÉMARRER SYSTÈME</button>
    <button onclick="exportCSV()">EXPORT CSV</button>
</div>

<div id="terminal" class="log-box"></div>

<script>
    let state = { v: 0, alt: 0, p0: null, lastT: performance.now(), motionLevel: 0 };
    let video, canvas, ctx, prevFrame;

    async function startAll() {
        log("Initialisation ARCHÈ V5100...");
        
        // 1. Accès Caméra pour Voxel-Proxy
        video = document.getElementById('camera-preview');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
            video.srcObject = stream;
            log("Voxel-Proxy : Flux vidéo activé.");
            analyzeMotion();
        } catch(e) { log("Voxel-Proxy : Erreur caméra."); }

        // 2. Capteurs Inertiels
        window.addEventListener('devicemotion', (e) => {
            const now = performance.now();
            const dt = (now - state.lastT) / 1000;
            state.lastT = now;

            let acc = e.acceleration;
            let aMag = acc ? Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2) : 0;

            // --- CORRECTION SCIENTIFIQUE PAR VOXEL ---
            // Si le Voxel-Proxy ne voit aucun mouvement de pixels, on bride l'accéléromètre
            if (state.motionLevel < 5) { 
                state.v *= 0.9; // Amortissement drastique
            } else {
                state.v += (aMag * dt);
            }

            // Limitation physique (anti-triche 9000 m/s)
            state.v = Math.min(state.v, 40); 
            
            updateUI();
        });
        
        log("Moteur Inertiel : Connecté.");
    }

    function analyzeMotion() {
        canvas = document.createElement('canvas');
        ctx = canvas.getContext('2d');
        
        setInterval(() => {
            if (!video.videoWidth) return;
            canvas.width = 32; canvas.height = 32; // Basse résolution pour performance
            ctx.drawImage(video, 0, 0, 32, 32);
            const currentFrame = ctx.getImageData(0, 0, 32, 32).data;
            
            if (prevFrame) {
                let diff = 0;
                for (let i = 0; i < currentFrame.length; i += 4) {
                    diff += Math.abs(currentFrame[i] - prevFrame[i]);
                }
                state.motionLevel = diff / 1000; // Intensité du changement de pixels
                document.getElementById('v-voxel-bar').style.width = Math.min(state.motionLevel, 100) + "%";
            }
            prevFrame = currentFrame;
        }, 100);
    }

    function updateUI() {
        document.getElementById('v-val').innerText = state.v.toFixed(2);
        const trust = document.getElementById('trust-val');
        if (state.v > 0.5 && state.motionLevel < 5) {
            trust.innerText = "DOUTE"; trust.style.color = "var(--red)";
        } else {
            trust.innerText = "OK"; trust.style.color = "var(--green)";
        }
    }

    function log(m) {
        const t = document.getElementById('terminal');
        t.innerHTML = `<div>> ${m}</div>` + t.innerHTML;
    }
</script>
</body>
    </html>
