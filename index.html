<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCHE V84 • OMNI-REVEAL</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <style>
        :root { --ion: #00ffcc; --bg: #000; --panel: rgba(5,10,12,0.95); --warn: #ffaa00; --active: #00ff00; }
        * { box-sizing: border-box; font-family: 'JetBrains Mono', monospace; }
        body { margin: 0; background: #000; color: var(--ion); overflow: hidden; height: 100vh; font-size: 10px; }
        
        #map { position: fixed; inset: 0; filter: invert(1) contrast(1.2) brightness(0.15); z-index: 0; }
        #canvas-path { position: fixed; inset: 0; z-index: 1; pointer-events: none; }
        
        .hud { position: fixed; inset: 10px; display: grid; grid-template-columns: 280px 1fr 280px; grid-template-rows: auto 1fr auto; gap: 10px; pointer-events: none; z-index: 100; }
        .panel { background: var(--panel); border: 1px solid var(--ion); padding: 10px; pointer-events: auto; backdrop-filter: blur(8px); }
        
        .title { border-bottom: 1px solid var(--ion); margin-bottom: 8px; padding-bottom: 4px; font-weight: 900; letter-spacing: 1px; display: flex; justify-content: space-between; }
        .val { color: #fff; font-size: 1.2rem; font-weight: 900; }
        .unit { font-size: 0.7rem; color: var(--ion); margin-left: 2px; }
        .indicator { width: 6px; height: 6px; border-radius: 50%; display: inline-block; background: #333; margin-right: 4px; }
        .on { background: var(--active); box-shadow: 0 0 5px var(--active); }
        .btn { background: var(--ion); color: #000; border: none; padding: 10px; cursor: pointer; font-weight: 900; width: 100%; text-transform: uppercase; }
    </style>
</head>
<body>

<div id="map"></div>
<canvas id="canvas-path"></canvas>

<div id="boot" style="position:fixed; inset:0; background:#000; z-index:1000; display:flex; align-items:center; justify-content:center; flex-direction:column;">
    <h1 style="letter-spacing: 15px;">ARCHE_V84</h1>
    <p style="color:var(--warn)">RAW INERTIAL • NO FRICTION</p>
    <button class="btn" style="width:auto; padding:20px 60px;" onclick="CORE.ignite()">INITIALISER LE NOYAU</button>
</div>

<div class="hud">
    <div class="panel">
        <div class="title">HARDWARE LINK</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 5px;">
            <div><span id="st-baro" class="indicator"></span>BARO</div>
            <div><span id="st-mag" class="indicator"></span>MAG</div>
            <div><span id="st-lux" class="indicator"></span>LUX</div>
            <div><span id="st-acc" class="indicator"></span>ACCEL</div>
        </div>
        <hr style="border:0.5px solid #222; margin:8px 0;">
        <div>LUX: <span id="v-lux" class="val">--</span></div>
        <div>MAG: <span id="v-mag" class="val">--</span><span class="unit">µT</span></div>
    </div>

    <div></div>

    <div class="panel">
        <div class="title">DYNAMIC ANALYTICS</div>
        <div style="display:flex; justify-content:space-between;">V-RAW <span class="val" id="v-speed">0.00</span><span class="unit">m/s</span></div>
        <div style="display:flex; justify-content:space-between;">G-FORCE <span class="val" id="v-g">1.00</span><span class="unit">G</span></div>
        <div style="display:flex; justify-content:space-between;">MAX-G <span class="val" id="v-maxg" style="color:red;">1.00</span></div>
    </div>

    <div class="panel" style="grid-row: 3;">
        <div class="title">ALTITUDE RELATIVE</div>
        <div>ΔZ: <span class="val" id="v-alt">0.0</span><span class="unit">m</span></div>
        <div>P: <span id="v-pres">----</span><span class="unit">hPa</span></div>
        <button class="btn" style="font-size:0.6rem; margin-top:5px; padding:5px;" onclick="CORE.calibrate()">RESET REFERENCE</button>
    </div>

    <div class="panel" style="grid-row: 3;">
        <div class="title">PATHFINDER</div>
        <div>DIST: <span class="val" id="v-dist">0.0</span><span class="unit">m</span></div>
        <div style="font-size:0.7rem; color:var(--warn)">CAP: <span id="v-head">000</span>°</div>
        <button class="btn" style="margin-top:5px;" onclick="ARCHIVE.save()">EXPORT RAW DATA</button>
    </div>
</div>

<script>
const CORE = {
    active: false, p0: 1013.25, lastT: performance.now(),
    pos: {x:0, y:0, z:0}, vel: {x:0, y:0, z:0},
    maxG: 1.0, distance: 0, heading: 0,
    path: [{x:0, y:0}],

    async ignite() {
        if (window.DeviceMotionEvent?.requestPermission) await DeviceMotionEvent.requestPermission();
        document.getElementById('boot').style.display = 'none';

        // 1. Baromètre
        if ('PressureSensor' in window) {
            const baro = new PressureSensor({frequency: 25});
            baro.onreading = () => {
                this.currentP = baro.pressure;
                this.pos.z = 44330 * (1 - Math.pow(this.currentP / this.p0, 1/5.255));
                document.getElementById('v-alt').innerText = this.pos.z.toFixed(2);
                document.getElementById('v-pres').innerText = this.currentP.toFixed(1);
                document.getElementById('st-baro').classList.add('on');
            };
            baro.start();
        }

        // 2. Magnétomètre (Boussole brute)
        if ('Magnetometer' in window) {
            const mag = new Magnetometer({frequency: 10});
            mag.onreading = () => {
                const field = Math.sqrt(mag.x**2 + mag.y**2 + mag.z**2);
                document.getElementById('v-mag').innerText = field.toFixed(1);
                document.getElementById('st-mag').classList.add('on');
            };
            mag.start();
        }

        // 3. Luxmètre (Lumière)
        if ('AmbientLightSensor' in window) {
            const lux = new AmbientLightSensor();
            lux.onreading = () => {
                document.getElementById('v-lux').innerText = lux.illuminance;
                document.getElementById('st-lux').classList.add('on');
            };
            lux.start();
        }

        // 4. Accéléromètre & Gyro
        window.addEventListener('devicemotion', e => this.compute(e));
        window.addEventListener('deviceorientation', e => {
            this.heading = e.alpha || 0;
            document.getElementById('v-head').innerText = Math.round(this.heading).toString().padStart(3,'0');
        });
        document.getElementById('st-acc').classList.add('on');

        MAP_ENGINE.init();
        this.active = true;
        this.render();
    },

    calibrate() {
        this.p0 = this.currentP || 1013.25;
        this.vel = {x:0, y:0, z:0};
        this.distance = 0;
        this.path = [{x:0, y:0}];
    },

    compute(e) {
        if(!this.active) return;
        const now = performance.now();
        const dt = (now - this.lastT) / 1000;
        this.lastT = now;

        const acc = e.acceleration; // Linéaire sans gravité
        const gAcc = e.accelerationIncludingGravity;

        // G-FORCE (Brute)
        const currentG = Math.sqrt(gAcc.x**2 + gAcc.y**2 + gAcc.z**2) / 9.80665;
        if(currentG > this.maxG) this.maxG = currentG;

        // VITESSE (ZÉRO FRICTION - INTÉGRATION PURE)
        // Note: Sans friction, la vitesse accumule les erreurs (drift)
        this.vel.x += acc.x * dt;
        this.vel.y += acc.y * dt;
        
        const speedMS = Math.sqrt(this.vel.x**2 + this.vel.y**2);
        this.distance += speedMS * dt;

        // Path (Projection polaire)
        const rad = (this.heading * Math.PI) / 180;
        const last = this.path[this.path.length-1];
        this.path.push({
            x: last.x + Math.sin(rad) * speedMS * dt * 10,
            y: last.y - Math.cos(rad) * speedMS * dt * 10
        });
        if(this.path.length > 1500) this.path.shift();

        this.updateHUD(currentG, speedMS);
    },

    updateHUD(g, s) {
        document.getElementById('v-g').innerText = g.toFixed(3);
        document.getElementById('v-maxg').innerText = this.maxG.toFixed(3);
        document.getElementById('v-speed').innerText = s.toFixed(3);
        document.getElementById('v-dist').innerText = this.distance.toFixed(2);
    },

    render() {
        const c = document.getElementById('canvas-path'), ctx = c.getContext('2d');
        c.width = window.innerWidth; c.height = window.innerHeight;
        const draw = () => {
            ctx.clearRect(0,0,c.width, c.height);
            ctx.strokeStyle = '#ffaa00'; ctx.lineWidth = 2;
            ctx.beginPath();
            const cx = c.width/2, cy = c.height/2;
            this.path.forEach((p, i) => {
                const sx = cx + p.x * 20, sy = cy + p.y * 20;
                if(i === 0) ctx.moveTo(sx, sy); else ctx.lineTo(sx, sy);
            });
            ctx.stroke();
            requestAnimationFrame(draw);
        };
        draw();
    }
};

const MAP_ENGINE = {
    init() {
        const m = L.map('map', {zoomControl: false, attributionControl: false}).setView([43.2965, 5.3698], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);
    }
};

const ARCHIVE = {
    save() {
        const d = { time: Date.now(), g: CORE.maxG, dist: CORE.distance, raw_v: CORE.vel };
        const blob = new Blob([JSON.stringify(d)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `RAW_OMNI_${Date.now()}.json`;
        a.click();
    }
};
</script>
</body>
                     </html>
