<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCHÈ V100 | SOUVERAINETÉ ABSOLUE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ephemjs@1.1.0/dist/ephem.min.js"></script>
    <style>
        :root { --green: #00ff41; --blue: #00f3ff; --gold: #ffd700; --bg: #050505; }
        body { background: var(--bg); color: var(--green); font-family: 'Courier New', monospace; margin: 0; padding: 15px; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { border-bottom: 1px solid var(--green); display: flex; justify-content: space-between; font-size: 0.8rem; padding-bottom: 5px; }
        #v-screen { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #disp-v { font-size: 15vw; font-weight: bold; color: white; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .mod { background: #111; border: 1px solid #333; padding: 10px; font-size: 0.7rem; }
        .mod span { display: block; color: #888; font-size: 0.6rem; }
        button { width: 100%; padding: 15px; background: none; border: 1px solid var(--green); color: var(--green); font-weight: bold; cursor: pointer; margin-bottom: 5px; }
        button:disabled { color: #444; border-color: #444; }
        #log-area { font-size: 0.5rem; color: #444; text-align: center; }
    </style>
</head>
<body>

<header><span>ARCHÈ V100 // S10e CORE</span><span id="clock">--:--:--</span></header>

<div id="v-screen">
    <div id="disp-v">0.000000</div>
    <div style="font-size: 0.8rem; color: #555;">VITESSE VECTORIELLE (m/s)</div>
</div>

<div class="grid">
    <div class="mod"><span>PHYSIQUE</span><div id="ui-mode">INIT...</div></div>
    <div class="mod"><span>LORENTZ (γ)</span><div id="ui-gamma">1.00000000</div></div>
    <div class="mod"><span>BRUIT Σ (ZUPT)</span><div id="ui-sigma">--</div></div>
    <div class="mod"><span>TEMP CPU</span><div id="ui-temp">--</div></div>
</div>

<button id="btn-main" onclick="ArcheCore.start()">INITIALISER LE SYSTÈME (10s)</button>
<button id="btn-csv" onclick="ArcheCore.exportCSV()" disabled>EXPORTER DONNÉES (.CSV)</button>
<div id="log-area">SÉCURITÉ : SHA256_PENDING</div>

<script>
math.config({ number: 'BigNumber', precision: 38 });
const _BN = (n) => math.bignumber(String(n || 0));
const C = _BN('299792458');

const ArcheCore = {
    state: {
        v: { x: _BN(0), y: _BN(0), z: _BN(0) },
        bias: { x: _BN(0), y: _BN(0), z: _BN(0) },
        sigma: _BN(0),
        temp: 30.0,
        logs: [],
        isCalibrated: false
    },

    async start() {
        const btn = document.getElementById('btn-main');
        if (typeof DeviceMotionEvent.requestPermission === 'function') await DeviceMotionEvent.requestPermission();
        
        btn.disabled = true;
        let samples = { x: [], y: [], z: [] };
        
        const monitor = (e) => {
            samples.x.push(e.acceleration.x);
            samples.y.push(e.acceleration.y);
            samples.z.push(e.acceleration.z);
        };

        window.addEventListener('devicemotion', monitor);
        for(let i=10; i>0; i--) {
            btn.innerText = `CALIBRATION : ${i}s`;
            await new Promise(r => setTimeout(r, 1000));
        }
        window.removeEventListener('devicemotion', monitor);

        // Calcul du Biais (Offset constant) et du Sigma (Bruit)
        this.state.bias.x = _BN(math.mean(samples.x));
        this.state.bias.y = _BN(math.mean(samples.y));
        this.state.bias.z = _BN(math.mean(samples.z));
        this.state.sigma = _BN(math.std(samples.x));
        
        document.getElementById('ui-sigma').innerText = this.state.sigma.toFixed(8);
        this.state.isCalibrated = true;
        this.engine();
    },

    engine() {
        document.getElementById('btn-main').innerText = "SYSTÈME ACTIF (MESURE EN COURS)";
        document.getElementById('btn-csv').disabled = false;
        
        window.addEventListener('devicemotion', (e) => {
            const dt = _BN(e.interval / 1000);
            const raw = e.acceleration;
            if(!raw.x) return;

            // 1. Correction du Biais & Filtre Deadzone (2*sigma)
            const clean = (val, bias) => {
                let v = math.subtract(_BN(val), bias);
                return math.abs(v).gt(math.multiply(this.state.sigma, 2)) ? v : _BN(0);
            };

            const ax = clean(raw.x, this.state.bias.x);
            const ay = clean(raw.y, this.state.bias.y);
            const az = clean(raw.z, this.state.bias.z);

            // 2. Intégration Vectorielle
            this.state.v.x = math.add(this.state.v.x, math.multiply(ax, dt));
            this.state.v.y = math.add(this.state.v.y, math.multiply(ay, dt));
            this.state.v.z = math.add(this.state.v.z, math.multiply(az, dt));

            const vNorm = math.norm([this.state.v.x, this.state.v.y, this.state.v.z]);

            // 3. Relativité
            const gamma = math.divide(_BN(1), math.sqrt(math.subtract(_BN(1), math.divide(math.pow(vNorm, 2), math.pow(C, 2)))));

            // 4. Update UI
            document.getElementById('disp-v').innerText = vNorm.toFixed(6);
            document.getElementById('ui-gamma').innerText = gamma.toFixed(10);
            document.getElementById('ui-mode').innerText = (math.norm([e.accelerationIncludingGravity.x, e.accelerationIncludingGravity.y, e.accelerationIncludingGravity.z]) < 1) ? "EINSTEIN" : "NEWTON";
            
            // Logging
            if(this.state.logs.length < 5000) {
                this.state.logs.push({ t: Date.now(), v: vNorm.toString(), g: gamma.toString() });
            }
        });
    },

    exportCSV() {
        let content = "timestamp,velocity_ms,gamma\n";
        this.state.logs.forEach(l => content += `${l.t},${l.v},${l.g}\n`);
        const blob = new Blob([content], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `arche_v100_data.csv`; a.click();
    }
};

setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);
</script>
</body>
</html>
