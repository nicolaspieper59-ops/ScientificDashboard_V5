<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCHÈ X-13 | AUTONOMIE TOTALE</title>
    <script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.min.js"></script>
    <style>
        :root { --gold: #ffaa00; --bg: #000; --text: #00ff41; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: monospace; overflow: hidden; }
        #monitor { height: 100vh; display: flex; flex-direction: column; padding: 10px; }
        .data-stream { flex-grow: 1; border: 1px solid #222; margin-top: 10px; font-size: 0.75rem; overflow: hidden; position: relative; }
        .status-bar { display: flex; justify-content: space-between; border-bottom: 1px solid var(--gold); padding: 5px; font-weight: bold; }
        #velocity-display { font-size: 4rem; text-align: center; color: #fff; margin: 20px 0; font-family: 'Orbitron', sans-serif; }
    </style>
</head>
<body>

<div id="monitor">
    <div class="status-bar">
        <span>MODE: <span id="auto-mode">INITIALISATION...</span></span>
        <span>LAT: <span id="auto-lat">0.000</span></span>
        <span>G: <span id="auto-g">9.806</span></span>
    </div>
    
    <div id="velocity-display">0.000000</div>
    
    <div class="data-stream" id="log-stream">
        > SYSTÈME AUTO-SOUVERAIN ACTIVÉ...<br>
        > ÉCOUTE DES FLUX PHYSIQUES EN COURS...
    </div>
</div>

<script>
    /**
     * NOYAU D'AUTONOMIE X-13
     * Gestion automatique des milieux et de la gravitation
     */
    
    let state = {
        v: 0,
        g: 9.80665,
        density: 1.225,
        friction: 0.47,
        lastT: performance.now(),
        isUnderwater: false
    };

    // 1. DÉTECTION AUTOMATIQUE DU MILIEU (BAROMÈTRE)
    if ('PressureSensor' in window) {
        const baro = new PressureSensor({frequency: 2});
        baro.addEventListener('reading', () => {
            let p = baro.value;
            // Transition automatique Air -> Grotte -> Eau
            if (p > 1050) { // Seuil d'immersion
                state.density = 1027; 
                state.friction = 0.85;
                state.isUnderwater = true;
                updateUI("HYDROSPHÈRE", "#00d4ff");
            } else if (p > 1020) { // Seuil Grotte / Haute pression
                state.density = 1.250;
                state.isUnderwater = false;
                updateUI("CAVEE / PROFOND", "#ff4400");
            } else {
                state.density = 1.225;
                state.isUnderwater = false;
                updateUI("ATMOSPHÈRE", "#00ff41");
            }
        });
        baro.start();
    }

    // 2. AUTO-CALIBRATION GÉODÉSIQUE (SOMIGLIANA)
    navigator.geolocation.watchPosition(pos => {
        let lat = pos.coords.latitude;
        document.getElementById('auto-lat').innerText = lat.toFixed(3);
        
        // Formule de Somigliana automatique
        const g_eq = 9.78032677;
        const k = 0.0019318513;
        const e2 = 0.0066943800;
        const rad = lat * Math.PI / 180;
        state.g = g_eq * (1 + k * Math.pow(Math.sin(rad), 2)) / Math.sqrt(1 - e2 * Math.pow(Math.sin(rad), 2));
        document.getElementById('auto-g').innerText = state.g.toFixed(5);
    }, null, {enableHighAccuracy: true});

    // 3. NAVIGATION INERTIELLE À L'ESTIME AUTOMATIQUE
    window.addEventListener('devicemotion', e => {
        let now = performance.now();
        let dt = (now - state.lastT) / 1000;
        state.lastT = now;

        let acc = e.acceleration;
        if(!acc || acc.x === null) return;

        let aMag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
        
        // Filtre de Kalman adaptatif (bruit MEMS)
        if (aMag < 0.1) aMag = 0;

        // Calcul de traînée automatique selon le milieu détecté
        let drag = (0.5 * state.density * Math.pow(state.v/1000, 2) * state.friction) / 0.2;
        
        state.v += (aMag - drag) * dt * 1000;
        if(state.v < 0) state.v = 0;

        document.getElementById('velocity-display').innerText = state.v.toFixed(6);
    });

    function updateUI(mode, color) {
        let el = document.getElementById('auto-mode');
        el.innerText = mode;
        el.style.color = color;
    }

    function addLog(msg) {
        const log = document.getElementById('log-stream');
        log.innerHTML = `> ${msg}<br>` + log.innerHTML;
    }
</script>
</body>
</html>
