<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ARCHE V97 • GALACTIC SEXTANT</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="ephem.js"></script>
    <script src="weather.js"></script>

    <style>
        :root { --ion: #00ffcc; --astro: #ffaa00; --bg: #020202; }
        body { margin: 0; background: var(--bg); color: var(--ion); font-family: 'JetBrains Mono', monospace; overflow: hidden; }
        #map { position: fixed; inset: 0; filter: invert(1) contrast(1.1) brightness(0.1) grayscale(1); z-index: 0; }
        
        /* Overlay Sextant Caméra (Simulé) */
        #sextant-overlay { 
            position: fixed; inset: 0; border: 2px solid rgba(0,255,204,0.1);
            pointer-events: none; z-index: 5;
            background: radial-gradient(circle, transparent 20%, rgba(0,0,0,0.4) 100%);
        }

        .hud { position: fixed; inset: 20px; display: grid; grid-template-columns: 300px 1fr 300px; gap: 20px; pointer-events: none; z-index: 100; }
        .panel { background: rgba(5,8,10,0.9); border: 1px solid var(--ion); padding: 15px; pointer-events: auto; backdrop-filter: blur(10px); }
        .val { color: #fff; font-size: 1.3em; font-variant-numeric: tabular-nums; }
        .label { font-size: 0.8em; opacity: 0.6; text-transform: uppercase; }
        
        .crosshair { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; border: 1px solid var(--astro); transform: translate(-50%, -50%); border-radius: 50%; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="sextant-overlay"><div class="crosshair"></div></div>

<div class="hud">
    <div class="panel">
        <div style="font-weight: 900; border-bottom: 1px solid var(--astro); color: var(--astro); margin-bottom:10px;">CELESTIAL DATA</div>
        
        <div class="label">Soleil (Azimut)</div>
        <div class="val" id="sun-azi">--°</div>
        
        <div class="label">Lune (Azimut)</div>
        <div class="val" id="moon-azi">--°</div>
        
        <div class="label" style="margin-top:15px;">Élévation Solaire</div>
        <div id="sun-gauge" style="width:100%; height:4px; background:#222; margin-top:5px;">
            <div id="sun-bar" style="width:0%; height:100%; background:var(--astro);"></div>
        </div>
    </div>

    <div style="display:flex; align-items:center; justify-content:center;">
        <div style="text-align:center; background:rgba(0,0,0,0.5); padding:10px;">
            <div class="label">Viseur Sextant</div>
            <div id="v-sync" style="color:var(--astro)">SCANNING HORIZON...</div>
        </div>
    </div>

    <div class="panel">
        <div style="font-weight: 900; border-bottom: 1px solid var(--ion); margin-bottom:10px;">SLAM ENGINE (128b)</div>
        
        <div class="label">Vitesse Scalaire</div>
        <div class="val" id="v-speed">0.0000 <span style="font-size:0.5em">m/s</span></div>
        
        <div class="label">Position X (Prec)</div>
        <div class="val" id="v-posx" style="font-size:0.9em">0.000000</div>
        
        <div class="label">Position Y (Prec)</div>
        <div class="val" id="v-posy" style="font-size:0.9em">0.000000</div>

        <button onclick="CORE.reset()" style="margin-top:20px; width:100%; background:var(--ion); border:none; padding:10px; font-weight:bold; cursor:pointer;">RE-CALIBRER CAP</button>
    </div>
</div>

<script>
math.config({ number: 'BigNumber', precision: 32 });

const CORE = {
    pos: { x: math.bignumber(0), y: math.bignumber(0) },
    v: { x: math.bignumber(0), y: math.bignumber(0) },
    heading: 0,
    lastT: performance.now(),

    init() {
        this.setupMap();
        this.startAstro();
        this.startInertia();
        this.render();
    },

    setupMap() {
        this.map = L.map('map', { zoomControl: false, attributionControl: false }).setView([48.85, 2.34], 18);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.map);
    },

    startAstro() {
        setInterval(() => {
            const now = new Date();
            // Utilisation des données de ephem.js
            if(typeof vsop2013 !== 'undefined') {
                const jd = now.getTime() / 1000.0;
                const sun = vsop2013.earth.position(jd);
                
                // Calcul Azimut (simplifié pour le démonstrateur)
                const azi = (Math.atan2(sun.y, sun.x) * 180 / Math.PI + 360) % 360;
                const elev = Math.atan2(sun.z, Math.sqrt(sun.x**2 + sun.y**2)) * 180 / Math.PI;

                document.getElementById('sun-azi').innerText = azi.toFixed(2) + "°";
                document.getElementById('sun-bar').style.width = Math.max(0, elev) + "%";
                
                if(elev < 0) document.getElementById('v-sync').innerText = "MODE: LUNAIRE ACTIVE";
                else document.getElementById('v-sync').innerText = "MODE: SOLAIRE ACTIVE";
            }
        }, 1000);
    },

    startInertia() {
        window.addEventListener('devicemotion', (e) => {
            const now = performance.now();
            const dt = math.bignumber((now - this.lastT) / 1000);
            this.lastT = now;

            let ax = math.bignumber(e.acceleration.x || 0);
            let ay = math.bignumber(e.acceleration.y || 0);

            // Filtrage bruit 128-bit
            if (math.abs(ax).lt(0.1)) ax = math.bignumber(0);
            if (math.abs(ay).lt(0.1)) ay = math.bignumber(0);

            // Rotation du vecteur selon le cap
            const rad = this.heading * Math.PI / 180;
            const cos = math.bignumber(Math.cos(rad));
            const sin = math.bignumber(Math.sin(rad));

            const worldX = math.subtract(math.multiply(ax, cos), math.multiply(ay, sin));
            const worldY = math.add(math.multiply(ax, sin), math.multiply(ay, cos));

            // Intégration
            this.v.x = math.add(this.v.x, math.multiply(worldX, dt));
            this.v.y = math.add(this.v.y, math.multiply(worldY, dt));
            
            this.pos.x = math.add(this.pos.x, math.multiply(this.v.x, dt));
            this.pos.y = math.add(this.pos.y, math.multiply(this.v.y, dt));

            // UI Update
            const speed = math.sqrt(math.add(math.square(this.v.x), math.square(this.v.y)));
            document.getElementById('v-speed').innerText = math.format(speed, {precision: 5});
            document.getElementById('v-posx').innerText = math.format(this.pos.x, {notation: 'fixed', precision: 6});
            document.getElementById('v-posy').innerText = math.format(this.pos.y, {notation: 'fixed', precision: 6});
        });

        window.addEventListener('deviceorientation', (e) => {
            this.heading = e.alpha || 0;
        });
    },

    reset() {
        this.v.x = math.bignumber(0);
        this.v.y = math.bignumber(0);
        this.pos.x = math.bignumber(0);
        this.pos.y = math.bignumber(0);
    },

    render() {
        // Optionnel : Tracer la ligne de déplacement sur la carte ici
        requestAnimationFrame(() => this.render());
    }
};

window.onload = () => CORE.init();
</script>
</body>
        </html>
