<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCHE V76 • ABYSS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        :root { --ion: #00ffcc; --bg: #000; --panel: rgba(5,8,8,0.98); --active: #00ff00; --off: #555; }
        body { margin: 0; background: #000; color: var(--ion); font-family: 'JetBrains Mono', monospace; overflow: hidden; height: 100vh; font-size: 10px; }
        #map { position: fixed; inset: 0; filter: invert(1) contrast(1.2); opacity: 0.25; }
        #canvas-3d { position: fixed; inset: 0; z-index: 1; }
        .hud { position: fixed; inset: 10px; display: grid; grid-template-columns: 280px 1fr 280px; grid-template-rows: auto 1fr auto; gap: 10px; pointer-events: none; z-index: 100; }
        .panel { background: var(--panel); border: 1px solid var(--ion); padding: 12px; pointer-events: auto; backdrop-filter: blur(5px); }
        .val { color: #fff; font-size: 1.2rem; font-weight: 900; }
        .indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .on { background: var(--active); box-shadow: 0 0 10px var(--active); }
        .off { background: var(--off); }
        .label-group { display: flex; align-items: center; border-bottom: 1px solid #222; margin-bottom: 8px; padding-bottom: 4px; }
    </style>
</head>
<body>

<div id="map"></div>
<canvas id="canvas-3d"></canvas>

<div id="boot" style="position:fixed; inset:0; background:#000; z-index:1000; display:flex; align-items:center; justify-content:center; flex-direction:column;">
    <h1 style="letter-spacing: 15px;">ARCHE_V76</h1>
    <p>MODULE ALTIMÉTRIQUE & KINÉTIQUE INTÉGRÉ</p>
    <button style="padding: 20px 40px; background: var(--ion); border: none; font-weight: 900; cursor: pointer;" onclick="CORE.ignite()">ACTIVER LE NOYAU</button>
</div>

<div class="hud">
    <div class="panel">
        <div class="label-group">STATUT DES SYSTÈMES</div>
        <div><span id="st-acc" class="indicator off"></span> ACCÉLÉROMÈTRE</div>
        <div><span id="st-gyro" class="indicator off"></span> GYROSCOPE (SALTO)</div>
        <div><span id="st-baro" class="indicator off"></span> BAROMÈTRE (GROTTE)</div>
        <div style="margin-top:10px; color:white;">MODE: <span id="v-mode">INITIALISATION</span></div>
    </div>

    <div></div>

    <div class="panel">
        <div class="label-group">MÉTROLOGIE VERTICALE</div>
        <div class="data">ALTITUDE: <span class="val" id="v-alt">---</span> m</div>
        <div class="data">PRESSION: <span id="v-pres">---</span> hPa</div>
        <div class="data" style="margin-top:5px;">CHARGE G: <span class="val" id="v-g">1.00</span></div>
    </div>

    <div class="panel" style="grid-row: 3;">
        <div class="label-group">LOCALISATION INERTIELLE 3D</div>
        <div class="data">ΔX:<span id="v-x">0</span> ΔY:<span id="v-y">0</span> ΔZ:<span id="v-z">0</span></div>
        <div class="data">TRAJECTOIRE: <span class="val" id="v-dist">0.00</span> m</div>
    </div>

    <div class="panel" style="grid-row: 3;">
        <button style="width:100%; padding: 10px; background: var(--ion); border:none; font-weight:900;" onclick="ARCHIVE.save()">EXPORT MISSION .REAL</button>
    </div>
</div>

<script>
const CORE = {
    pos: {x: 0, y: 0, z: 0},
    vel: {x: 0, y: 0, z: 0},
    baseAlt: null,
    lastT: 0,
    dist: 0,

    async ignite() {
        if (typeof DeviceMotionEvent.requestPermission === 'function') await DeviceMotionEvent.requestPermission();
        document.getElementById('boot').style.display = 'none';
        this.lastT = performance.now();
        
        // Init Accel & Gyro
        window.addEventListener('devicemotion', (e) => {
            this.updateKinetic(e);
            document.getElementById('st-acc').className = "indicator on";
            if(e.rotationRate?.alpha) document.getElementById('st-gyro').className = "indicator on";
        });

        // Init Baromètre (Altitude)
        if ('RelativeOrientationSensor' in window || 'AbsoluteOrientationSensor' in window) {
            // Certains navigateurs supportent l'accès direct aux capteurs environnementaux
        }
        
        // Simulation/Accès pression si disponible via l'API Generic Sensor ou baromètre standard
        if ('PressureSensor' in window) {
            const sensor = new PressureSensor({frequency: 10});
            sensor.addEventListener('reading', () => this.updateBaro(sensor.pressure));
            sensor.start();
            document.getElementById('st-baro').className = "indicator on";
        } else {
            document.getElementById('v-pres').innerText = "NON SUPPORTÉ";
        }

        this.render();
    },

    updateKinetic(e) {
        const now = performance.now();
        const dt = (now - this.lastT) / 1000;
        this.lastT = now;

        const acc = e.acceleration;
        const rot = e.rotationRate;
        const g = e.accelerationIncludingGravity;

        // Force G
        const gForce = Math.sqrt(g.x**2 + g.y**2 + g.z**2) / 9.80665;
        document.getElementById('v-g').innerText = gForce.toFixed(2);

        // Mode Détection
        const totalRot = Math.abs(rot.alpha) + Math.abs(rot.beta) + Math.abs(rot.gamma);
        document.getElementById('v-mode').innerText = totalRot > 150 ? "KINETIC (SALTO)" : "STABLE";

        // Integration 3D
        ['x', 'y', 'z'].forEach(axis => {
            let a = acc[axis] || 0;
            if(Math.abs(a) < 0.15) a = 0;
            this.vel[axis] += a * dt;
            this.pos[axis] += this.vel[axis] * dt;
            this.vel[axis] *= 0.97; // Friction anti-dérive
        });

        this.dist += Math.sqrt((this.vel.x*dt)**2 + (this.vel.y*dt)**2 + (this.vel.z*dt)**2);
        
        this.updateHUD();
    },

    updateBaro(p) {
        // Formule barométrique : H = 44330 * (1 - (P/P0)^(1/5.255))
        if(this.baseAlt === null) this.baseAlt = p;
        const altitude = 44330 * (1 - Math.pow(p / 1013.25, 1/5.255));
        document.getElementById('v-alt').innerText = altitude.toFixed(1);
        document.getElementById('v-pres').innerText = p.toFixed(2);
    },

    updateHUD() {
        document.getElementById('v-x').innerText = this.pos.x.toFixed(1);
        document.getElementById('v-y').innerText = this.pos.y.toFixed(1);
        document.getElementById('v-z').innerText = this.pos.z.toFixed(1);
        document.getElementById('v-dist').innerText = this.dist.toFixed(2);
    },

    render() {
        const c = document.getElementById('canvas-3d'), ctx = c.getContext('2d');
        c.width = window.innerWidth; c.height = window.innerHeight;
        const draw = () => {
            ctx.clearRect(0,0,c.width, c.height);
            ctx.strokeStyle = '#00ffcc';
            ctx.beginPath();
            ctx.moveTo(c.width/2, c.height/2);
            ctx.lineTo(c.width/2 + this.pos.x * 25, c.height/2 + this.pos.y * 25);
            ctx.stroke();
            requestAnimationFrame(draw);
        };
        draw();
    }
};

const ARCHIVE = {
    save() {
        const data = { mission: "ARCHE_V76", pos: CORE.pos, dist: CORE.dist, date: new Date() };
        const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `MISSION_ABYSS.REAL`;
        a.click();
    }
}
</script>
</body>
</html>
