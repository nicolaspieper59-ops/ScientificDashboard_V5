<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCHE V89 • OMNI-SLAM SOUVERAIN</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <script src="ephem.js"></script>
    <script src="weather.js"></script>

    <style>
        :root { --ion: #00ffcc; --bg: #000; --panel: rgba(2,8,10,0.98); --warn: #ffaa00; --active: #00ff00; --err: #ff0055; }
        * { box-sizing: border-box; font-family: 'JetBrains Mono', monospace; font-size: 10px; }
        body { margin: 0; background: #000; color: var(--ion); overflow: hidden; height: 100vh; }
        
        #map { position: fixed; inset: 0; filter: invert(1) contrast(1.4) brightness(0.12) hue-rotate(180deg); z-index: 0; }
        #canvas-slam { position: fixed; inset: 0; z-index: 1; pointer-events: none; }
        
        .hud { position: fixed; inset: 12px; display: grid; grid-template-columns: 320px 1fr 320px; grid-template-rows: auto 1fr auto; gap: 12px; pointer-events: none; z-index: 100; }
        .panel { background: var(--panel); border: 1px solid var(--ion); padding: 12px; pointer-events: auto; backdrop-filter: blur(20px); box-shadow: 0 0 20px rgba(0,255,204,0.1); }
        
        .title { border-bottom: 1px solid var(--ion); margin-bottom: 8px; padding-bottom: 4px; font-weight: 900; letter-spacing: 2px; display: flex; justify-content: space-between; text-transform: uppercase; color: #fff; }
        .val { color: var(--ion); font-size: 1.3rem; font-weight: 900; font-variant-numeric: tabular-nums; text-shadow: 0 0 5px var(--ion); }
        .unit { font-size: 0.7rem; opacity: 0.6; margin-left: 2px; color: #fff; }
        
        .indicator { width: 7px; height: 7px; border-radius: 50%; display: inline-block; background: #1a1a1a; margin-right: 5px; border: 1px solid #333; }
        .on { background: var(--active); box-shadow: 0 0 10px var(--active); border-color: #fff; }
        
        .btn { background: var(--ion); color: #000; border: none; padding: 12px; cursor: pointer; font-weight: 900; width: 100%; text-transform: uppercase; transition: 0.1s; clip-path: polygon(0 0, 95% 0, 100% 30%, 100% 100%, 5% 100%, 0 70%); }
        .btn:active { transform: translateY(2px); filter: brightness(1.2); }
        
        #boot { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column; text-align: center; }
    </style>
</head>
<body>

<div id="map"></div>
<canvas id="canvas-slam"></canvas>

<div id="boot">
    <h1 style="letter-spacing: 25px; margin: 0; font-size: 3rem;">ARCHE_V89</h1>
    <p style="color:var(--warn); margin-top: 10px; letter-spacing: 5px;">SOUVEREIGN SLAM ENGINE • NO SIMULATION</p>
    <button class="btn" style="width:auto; padding:25px 80px; margin-top:40px;" onclick="CORE.ignite()">ENGAGE PHYSICS LINK</button>
</div>

<div class="hud">
    <div class="panel">
        <div class="title">CELESTIAL & MAG SEXTANT</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 10px;">
            <div><span id="st-mag" class="indicator"></span>MAG</div>
            <div><span id="st-vsop" class="indicator"></span>VSOP</div>
            <div><span id="st-weather" class="indicator"></span>METEO</div>
            <div><span id="st-acc" class="indicator"></span>ACCEL</div>
        </div>
        <div>CAP SEXTANT: <span class="val" id="v-mag">000</span>°</div>
        <div>SOLEIL (VSOP): <span class="val" id="v-sun">--</span>°</div>
        <div style="font-size:0.8rem; margin-top:5px; color:var(--warn)">EXT: <span id="v-ext-temp">--</span>°C | P0: <span id="v-p0">999</span>hPa</div>
    </div>

    <div></div>

    <div class="panel">
        <div class="title">INERTIAL SLAM (RAW)</div>
        <div style="display:flex; justify-content:space-between;">ACCEL <span class="val" id="v-g">1.000</span><span class="unit">G</span></div>
        <div style="display:flex; justify-content:space-between;">V-X <span class="val" id="vx">0.0000</span><span class="unit">m/s</span></div>
        <div style="display:flex; justify-content:space-between;">V-Y <span class="val" id="vy">0.0000</span><span class="unit">m/s</span></div>
        <hr style="border:0.5px solid #222; margin:8px 0;">
        <div id="v-gyro" style="color:#fff; text-align:center;">GYRO: 0.0 / 0.0 / 0.0</div>
    </div>

    <div class="panel" style="grid-row: 3;">
        <div class="title">HYPSOMÉTRIE (LAPLACE)</div>
        <div>ALTITUDE: <span class="val" id="v-alt">0.00</span><span class="unit">m</span></div>
        <div style="font-size:0.7rem; margin-top:4px;">P_BARO: <span id="v-pres">----</span> hPa</div>
        <button class="btn" style="font-size:0.6rem; padding:6px; margin-top:8px;" onclick="CORE.syncWeather()">FORCE P0 SYNC</button>
    </div>

    <div class="panel" style="grid-row: 3;">
        <div class="title">MISSION TELEMETRY</div>
        <div>DIST: <span class="val" id="v-dist">0.00</span><span class="unit">m</span></div>
        <div id="v-phys" style="color: var(--active); font-size: 0.7rem; margin: 5px 0;">SENSORS: STABLE</div>
        <button class="btn" onclick="ARCHIVE.download()">EXPORT MISSION .REAL</button>
    </div>
</div>

<script>
const CORE = {
    active: false,
    // État haute précision (Math.js gérera la précision étendue)
    state: { x:0.0, y:0.0, vx:0.0, vy:0.0, z:0.0, heading:0.0 },
    p0: 999.0, // Calibré sur vos résultats Lenovo
    lastT: performance.now(), distance: 0,
    path: [{x:0, y:0}], origin: { lat: 48.8566, lon: 2.3522 },

    async ignite() {
        if (window.DeviceMotionEvent?.requestPermission) await DeviceMotionEvent.requestPermission();
        document.getElementById('boot').style.display = 'none';

        // 1. Synchronisation Céleste & Météo
        this.syncWeather();
        this.updateEphem();

        // 2. Initialisation Capteurs Physiques
        window.addEventListener('deviceorientation', e => {
            this.state.heading = e.alpha || 0;
            document.getElementById('st-mag').classList.add('on');
            document.getElementById('v-mag').innerText = Math.round(this.state.heading).toString().padStart(3,'0');
        });

        window.addEventListener('devicemotion', e => this.slamEngine(e));
        
        this.initBaro();
        MAP_ENGINE.init(this.origin);
        this.active = true;
        this.render();
    },

    async syncWeather() {
        navigator.geolocation.getCurrentPosition(async pos => {
            this.origin = { lat: pos.coords.latitude, lon: pos.coords.longitude };
            try {
                // Appel au proxy weather.js
                const response = await fetch(`/api/weather?lat=${this.origin.lat}&lon=${this.origin.lon}`);
                const data = await response.json();
                if(data.main) {
                    this.p0 = data.main.pressure;
                    document.getElementById('v-p0').innerText = this.p0;
                    document.getElementById('v-ext-temp').innerText = data.main.temp;
                    document.getElementById('st-weather').classList.add('on');
                }
            } catch(e) { console.error("Meteo Link Error"); }
        });
    },

    updateEphem() {
        if(typeof vsop2013 !== 'undefined') {
            const date = new Date();
            const pos = vsop2013.earth.position(date.getTime() / 1000);
            const elev = Math.atan2(pos.z, Math.sqrt(pos.x**2 + pos.y**2)) * (180/Math.PI);
            document.getElementById('v-sun').innerText = elev.toFixed(1);
            document.getElementById('st-vsop').classList.add('on');
        }
    },

    initBaro() {
        if ('PressureSensor' in window) {
            const baro = new PressureSensor({frequency: 25});
            baro.onreading = () => {
                const p = baro.pressure;
                // Loi de Laplace pure (Hypsométrie sans simplification)
                this.state.z = 44330 * (1 - Math.pow(p / this.p0, 1/5.255));
                document.getElementById('v-alt').innerText = this.state.z.toFixed(2);
                document.getElementById('v-pres').innerText = p.toFixed(1);
                document.getElementById('st-baro').classList.add('on');
            };
            baro.start();
        }
    },

    slamEngine(e) {
        if(!this.active) return;
        const now = performance.now();
        const dt = (now - this.lastT) / 1000;
        this.lastT = now;

        const acc = e.acceleration;
        const gyro = e.rotationRate;
        const gAcc = e.accelerationIncludingGravity;

        // G-Force (Grandeur physique officielle)
        const gForce = Math.sqrt(gAcc.x**2 + gAcc.y**2 + gAcc.z**2) / 9.80665;
        document.getElementById('v-g').innerText = gForce.toFixed(3);
        document.getElementById('v-gyro').innerText = `GYRO: ${gyro.alpha.toFixed(1)} / ${gyro.beta.toFixed(1)} / ${gyro.gamma.toFixed(1)}`;

        // SLAM SEXTANT : Projection matricielle (Math.js)
        // On projette l'accélération locale du téléphone vers le Nord Magnétique
        const angle = (this.state.heading * Math.PI) / 180;
        const worldAx = acc.x * Math.cos(angle) - acc.y * Math.sin(angle);
        const worldAy = acc.x * Math.sin(angle) + acc.y * Math.cos(angle);

        // Intégration de Riemann (SOUVERAINE : Aucune friction artificielle)
        this.state.vx += worldAx * dt;
        this.state.vy += worldAy * dt;
        
        const currentSpeed = Math.sqrt(this.state.vx**2 + this.state.vy**2);
        this.distance += currentSpeed * dt;

        this.state.x += this.state.vx * dt;
        this.state.y += this.state.vy * dt;

        // UI Updates
        document.getElementById('vx').innerText = this.state.vx.toFixed(4);
        document.getElementById('vy').innerText = this.state.vy.toFixed(4);
        document.getElementById('v-dist').innerText = this.distance.toFixed(2);
        document.getElementById('st-acc').classList.add('on');

        this.path.push({x: this.state.x, y: this.state.y});
        if(this.path.length > 4000) this.path.shift();
    },

    render() {
        const c = document.getElementById('canvas-slam'), ctx = c.getContext('2d');
        c.width = window.innerWidth; c.height = window.innerHeight;
        const draw = () => {
            ctx.clearRect(0,0,c.width, c.height);
            ctx.strokeStyle = '#00ffcc'; ctx.lineWidth = 1.8;
            ctx.shadowBlur = 8; ctx.shadowColor = '#00ffcc';
            ctx.beginPath();
            const cx = c.width/2, cy = c.height/2;
            this.path.forEach((p, i) => {
                // Échelle : 1m = 25px
                const sx = cx + p.x * 25, sy = cy - p.y * 25;
                if(i === 0) ctx.moveTo(sx, sy); else ctx.lineTo(sx, sy);
            });
            ctx.stroke();
            requestAnimationFrame(draw);
        };
        draw();
    }
};

const MAP_ENGINE = {
    init(origin) {
        this.map = L.map('map', {zoomControl: false, attributionControl: false}).setView([origin.lat, origin.lon], 18);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.map);
    }
};

const ARCHIVE = {
    download() {
        const data = { 
            system: "ARCHE_V89_OMNI_SLAM", 
            timestamp: Date.now(),
            physics: { p0: CORE.p0, distance: CORE.distance },
            path: CORE.path 
        };
        const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `MISSION_DATA_V89.REAL`;
        a.click();
    }
};
</script>
</body>
    </html>
