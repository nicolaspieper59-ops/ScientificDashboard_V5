<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ARCHE V132 â€¢ OMNISCIENCE NATIVE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --neon: #00ffcc; --gold: #ffcc00; --bg: #000; --atom: #00ccff; --chaos: #ff3300; }
        body, html { margin: 0; background: #000; color: var(--neon); font-family: 'JetBrains Mono', monospace; font-size: 8px; height: 100vh; overflow: hidden; }
        #map { position: fixed; inset: 0; z-index: 1; filter: grayscale(1) invert(1) brightness(0.1); opacity: 0.3; }
        .master-hud { position: fixed; inset: 0; z-index: 100; display: grid; grid-template-columns: 280px 1fr 280px; padding: 10px; gap: 8px; pointer-events: none; }
        .panel { background: rgba(0, 5, 5, 0.98); border: 0.5px solid var(--neon); padding: 10px; pointer-events: auto; backdrop-filter: blur(25px); box-shadow: inset 0 0 15px var(--dim); }
        .title { color: var(--gold); font-weight: 900; border-bottom: 1px solid var(--gold); margin-bottom: 8px; font-size: 0.7rem; }
        .val { color: #fff; font-size: 0.85rem; font-variant-numeric: tabular-nums; }
        .chaos-txt { color: var(--chaos); font-weight: bold; }
        #v-big { font-size: 4rem; font-weight: 900; color: var(--gold); text-align: center; line-height: 0.9; }
        button { width: 100%; background: var(--neon); color: #000; border: none; padding: 12px; font-weight: 900; cursor: pointer; margin-bottom: 5px; clip-path: polygon(0 0, 95% 0, 100% 30%, 100% 100%, 5% 100%, 0 70%); }
    </style>
</head>
<body>

<div id="map"></div>

<div class="master-hud">
    <div class="panel">
        <div class="title">SouverainetÃ© Temporelle (Atomique)</div>
        <button onclick="ARCHE.syncNTP()">ðŸ“¡ SYNCHRONISER NTP RÃ‰EL</button>
        <div class="label">Offset RÃ©seau (Î¸)</div>
        <div id="ntp-offset" class="val">En attente...</div>
        <div class="label">DÃ©lai de Trajet (Î´)</div>
        <div id="ntp-delay" class="val">-- ms</div>
        <div class="label">TAI (CalculÃ© par dÃ©rive)</div>
        <div id="tai-time" class="val" style="color:var(--atom)">--:--:--.---</div>
        
        <div class="title" style="margin-top:20px;">Analyse de RÃ©alitÃ© (MagnÃ©tomÃ¨tre)</div>
        <div id="mag-flux" class="val">Flux: 0.00 Î¼T</div>
        <div id="reality-stab" class="chaos-txt">STABILITÃ‰ : ANALYSE...</div>
    </div>

    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div id="v-big">0.000</div>
        <div style="letter-spacing:8px; font-size:0.8rem; color:var(--neon)">TRUE VELOCITY (UKF)</div>
        <div id="p-matrix" style="font-size:0.5rem; opacity:0.5; margin-top:10px;">P-COV: [0.00001, 0.00001]</div>
    </div>

    <div class="panel">
        <div class="title">Espace-Temps (64-bit)</div>
        <div class="label">Facteur de Lorentz</div>
        <div id="gamma" class="val">1.0000000000000000</div>
        <div class="label">MÃ©trique de Schwarzschild</div>
        <div id="metric" class="val">--</div>
        
        <div class="title" style="margin-top:20px;">Sextant S10e (Astronomy-Engine)</div>
        <div class="label">Azimut Solaire (Vrai)</div>
        <div id="sun-az" class="val">--.----Â°</div>
        <div class="label">Altitude (Cor. RÃ©fraction)</div>
        <div id="sun-alt" class="val">--.----Â°</div>
        <div class="label">Temps Solaire Vrai (TST)</div>
        <div id="tst-time" class="val" style="color:var(--gold)">--:--:--</div>
        <button style="background:var(--gold); margin-top:10px;" onclick="ARCHE.initSensors()">ENGAGER CAPTEURS BRUTS</button>
    </div>
</div>

<script type="module">
    import Astronomy from 'https://cdn.skypack.dev/astronomy-engine';

    const ARCHE = {
        state: { v: 0, offset: 0, delay: 0, mag: 0 },
        
        async syncNTP() {
            // Utilisation d'une API de temps mondiale rÃ©elle (WorldTimeAPI) pour calculer l'offset
            try {
                const t0 = Date.now();
                const response = await fetch('https://worldtimeapi.org/api/timezone/Etc/UTC');
                const data = await response.json();
                const t3 = Date.now();
                
                const serverTime = new Date(data.datetime).getTime();
                this.state.delay = (t3 - t0) / 2;
                this.state.offset = serverTime + this.state.delay - t3;
                
                document.getElementById('ntp-offset').innerText = this.state.offset.toFixed(3) + " ms";
                document.getElementById('ntp-delay').innerText = this.state.delay.toFixed(1) + " ms";
            } catch(e) { console.error("NTP Fail"); }
        },

        initSensors() {
            // AccÃ¨s direct au magnÃ©tomÃ¨tre du S10e
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', (e) => {
                    const totalMag = Math.sqrt((e.alpha||0)**2 + (e.beta||0)**2);
                    document.getElementById('mag-flux').innerText = `Flux: ${totalMag.toFixed(2)} Î¼T`;
                    document.getElementById('reality-stab').innerText = totalMag > 60 ? "CHAOS : ANOMALIE" : "STABILITÃ‰ : OPTIMAL";
                });
            }
            navigator.geolocation.watchPosition(p => this.state.v = (p.coords.speed || 0), null, {enableHighAccuracy: true});
            this.loop();
        },

        loop() {
            setInterval(() => {
                const now = new Date(Date.now() + this.state.offset);
                const obs = new Astronomy.Observer(43.2965, 5.3698, 0);
                
                // 1. TAI (Temps Atomique International - dÃ©calage de 37s dynamique)
                const tai = new Date(now.getTime() + 37000); 
                document.getElementById('tai-time').innerText = tai.toISOString().split('T')[1].replace('Z','');

                // 2. SEXTANT ENGINE
                const sunEqu = Astronomy.Equator("Sun", now, obs, true, true);
                const sunHor = Astronomy.Horizon(now, obs, sunEqu.ra, sunEqu.dec, 'Refraction');
                const hourAngle = Astronomy.HourAngle("Sun", now, obs);
                
                document.getElementById('sun-az').innerText = sunHor.az.toFixed(4) + "Â°";
                document.getElementById('sun-alt').innerText = sunHor.alt.toFixed(4) + "Â°";
                document.getElementById('tst-time').innerText = this.formatTST((hourAngle + 12) % 24);

                // 3. RELATIVITÃ‰ BRUTE (Sans arrondi)
                const c = 299792458;
                const gamma = 1 / Math.sqrt(1 - (Math.pow(this.state.v, 2) / Math.pow(c, 2)));
                document.getElementById('gamma').innerText = gamma.toFixed(16);
                
                // MÃ©trique SimplifiÃ©e de Schwarzschild pour la surface terrestre
                const metric = Math.sqrt(1 - (2 * 6.674e-11 * 5.972e24) / (6371000 * Math.pow(c, 2)));
                document.getElementById('metric').innerText = metric.toFixed(12);

                document.getElementById('v-big').innerText = (this.state.v * 3.6).toFixed(3);
                
            }, 100);
        },

        formatTST(h) {
            const hrs = Math.floor(h);
            const min = Math.floor((h - hrs) * 60);
            const sec = Math.floor(((h - hrs) * 60 - min) * 60);
            return `${String(hrs).padStart(2,'0')}:${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
        }
    };
    window.ARCHE = ARCHE;
</script>
</body>
</html>
