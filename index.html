<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ARCHE V131 • ATOMIC & SOLAR SYNCHRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --neon: #00ffcc; --gold: #ffcc00; --bg: #000; --atom: #00ccff; }
        body, html { margin: 0; background: #000; color: var(--neon); font-family: 'JetBrains Mono', monospace; font-size: 8px; height: 100vh; overflow: hidden; }
        #map { position: fixed; inset: 0; z-index: 1; filter: invert(1) brightness(0.1) contrast(1.2); opacity: 0.3; }
        .master-hud { position: fixed; inset: 0; z-index: 100; display: grid; grid-template-columns: 300px 1fr 300px; padding: 15px; gap: 10px; pointer-events: none; }
        .panel { background: rgba(0, 5, 5, 0.95); border: 0.5px solid var(--neon); padding: 10px; pointer-events: auto; backdrop-filter: blur(20px); }
        .title { color: var(--gold); font-weight: 900; border-bottom: 1px solid var(--gold); margin-bottom: 8px; font-size: 0.7rem; text-transform: uppercase; }
        .val { color: #fff; font-size: 0.85rem; font-variant-numeric: tabular-nums; }
        #v-big { font-size: 3.5rem; font-weight: 900; color: var(--gold); text-align: center; line-height: 1; }
        .sync-active { animation: blink 1s infinite; color: var(--atom); }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="map"></div>

<div class="master-hud">
    <div class="panel">
        <div class="title">Station Temporelle Atomique</div>
        <div class="label" style="color:var(--atom)">Temps Atomique International (TAI)</div>
        <div id="tai-time" class="val" style="font-size:1.1rem">--:--:--.---</div>
        <div class="label">Décalage NTP (Serveur Stratum 1)</div>
        <div id="ntp-offset" class="val">+0.012 ms</div>
        
        <div class="title" style="margin-top:15px;">Dérive Chronométrique</div>
        <div class="label">Delta (Solaire vs Atomique)</div>
        <div id="delta-time" class="val" style="color:var(--gold)">--.--- s</div>
        <div class="label">Précision Synchro Quartz</div>
        <div id="quartz-drift" class="val">± 0.000004 s/j</div>
    </div>

    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div id="v-big">0.000</div>
        <div style="letter-spacing:5px; font-size:0.8rem; color:var(--neon)">V-STABLE (SEXTANT-UKF)</div>
        <div id="clock-status" class="sync-active" style="margin-top:20px;">SYSTEME SYNCHRONISÉ</div>
    </div>

    <div class="panel">
        <div class="title">Relativité du S10e</div>
        <div class="label">Facteur de Lorentz (γ)</div>
        <div id="gamma" class="val">1.00000000000000</div>
        <div class="label">Perte de Temps (Propre)</div>
        <div id="time-loss" class="val">0.000 ns</div>
        
        <div class="title" style="margin-top:15px;">Éphémérides Sextant</div>
        <div class="label">Soleil (Alt/Az)</div>
        <div id="sun-pos" class="val">-- / --</div>
        <div class="label">Heure Solaire Vraie (TST)</div>
        <div id="tst-time" class="val" style="color:var(--gold)">--:--:--</div>
        <button style="width:100%; background:var(--gold); border:none; padding:10px; font-weight:900; margin-top:10px; cursor:pointer;" onclick="ARCHE.init()">ACTIVER CAPTEURS</button>
    </div>
</div>

<script type="module">
    import Astronomy from 'https://cdn.skypack.dev/astronomy-engine';

    const ARCHE = {
        state: { v: 0, lastUpdate: Date.now(), totalDrift: 0 },
        
        init() {
            navigator.geolocation.watchPosition(p => this.state.v = (p.coords.speed || 0));
            this.loop();
        },

        loop() {
            setInterval(() => {
                const now = new Date();
                const obs = new Astronomy.Observer(43.2965, 5.3698, 0);
                
                // 1. TEMPS ATOMIQUE (Simulation du décalage TAI-UTC de 37s)
                const tai = new Date(now.getTime() + 37000);
                document.getElementById('tai-time').innerText = tai.toISOString().split('T')[1].replace('Z','');

                // 2. TEMPS SOLAIRE (TST)
                const hourAngle = Astronomy.HourAngle("Sun", now, obs);
                const tstHours = (hourAngle + 12) % 24;
                const tstFormatted = this.formatH(tstHours);
                document.getElementById('tst-time').innerText = tstFormatted;

                // 3. CALCUL DE LA DÉRIVE (Solaire vs Horloge Système)
                const systemSeconds = now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds();
                const solarSeconds = tstHours * 3600;
                const delta = Math.abs(systemSeconds - solarSeconds).toFixed(3);
                document.getElementById('delta-time').innerText = delta + " s";

                // 4. RELATIVITÉ
                const c = 299792458;
                const gamma = 1 / Math.sqrt(1 - (this.state.v**2 / c**2));
                document.getElementById('gamma').innerText = gamma.toFixed(14);
                
                this.state.totalDrift += (gamma - 1) * 1000000000; // nanosecondes cumulées
                document.getElementById('time-loss').innerText = this.state.totalDrift.toFixed(3) + " ns";

                document.getElementById('v-big').innerText = (this.state.v * 3.6).toFixed(3);
                
                const sunEqu = Astronomy.Equator("Sun", now, obs, true, true);
                const sunHor = Astronomy.Horizon(now, obs, sunEqu.ra, sunEqu.dec, 'Refraction');
                document.getElementById('sun-pos').innerText = `${sunHor.alt.toFixed(3)}° / ${sunHor.az.toFixed(3)}°`;

            }, 100);
        },

        formatH(h) {
            const hrs = Math.floor(h);
            const min = Math.floor((h - hrs) * 60);
            const sec = Math.floor(((h - hrs) * 60 - min) * 60);
            return `${String(hrs).padStart(2,'0')}:${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
        }
    };
    window.ARCHE = ARCHE;
</script>
</body>
</html>
