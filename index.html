<script>
math.config({ number: 'BigNumber', precision: 64 });

const KERNEL = {
    state: { 
        active: false, speed: 0, pos: math.bignumber(0), planck: math.bignumber(0),
        gear: 1, ratio: 0.200, lastFreq: 0, lastPixels: null, lastFrame: performance.now(),
        gVector: 1.000, coherenceScore: 100
    },
    const: { 
        tp: math.bignumber('5.391247e-44'), 
        invTp: math.divide(math.bignumber(1), math.bignumber('5.391247e-44')), // Pré-calcul crucial
        g: 9.80665 
    },

    async boot() {
        try {
            this.log("INIT_SÉQUENCE_ALPHA...");
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment", width: 640, frameRate: { ideal: 30 } }, 
                audio: { echoCancellation: false, noiseSuppression: false } 
            });
            
            document.getElementById('cam-preview').srcObject = stream;

            // AUDIO ENGINE
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (this.audioCtx.state === 'suspended') await this.audioCtx.resume();
            const source = this.audioCtx.createMediaStreamSource(stream);
            this.analyser = this.audioCtx.createAnalyser();
            this.analyser.fftSize = 1024; // Optimisé pour mobile
            source.connect(this.analyser);
            this.audioData = new Uint8Array(this.analyser.frequencyBinCount);

            // G-SENSOR HANDSHAKE
            if (window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function') {
                const permission = await DeviceMotionEvent.requestPermission();
                if (permission === 'granted') this.enableGListener();
            } else { this.enableGListener(); }

            this.canvasSlam = document.getElementById('slam-canvas');
            this.ctxSlam = this.canvasSlam.getContext('2d', {alpha: false});
            this.canvasAudio = document.getElementById('audio-viz');
            this.ctxAudio = this.canvasAudio.getContext('2d');
            
            document.getElementById('boot-btn').style.display = 'none';
            document.getElementById('ui-status').innerText = "SOUVERAINETÉ_TOTALE";
            this.state.active = true;
            this.loop();
        } catch (e) {
            this.log("CRITICAL_HARDWARE_FAILURE", true);
        }
    },

    enableGListener() {
        window.addEventListener('devicemotion', (e) => {
            const acc = e.accelerationIncludingGravity;
            if (acc && acc.z !== null) {
                this.state.gVector = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2) / this.const.g;
            }
        });
    },

    loop() {
        if(!this.state.active) return;
        const now = performance.now();
        const dt = (now - this.state.lastFrame) / 1000;
        this.state.lastFrame = now;

        // 1. ANALYSE HARMONIQUE
        this.analyser.getByteFrequencyData(this.audioData);
        let maxVal = 0, maxIdx = 0;
        for(let i=0; i<this.audioData.length; i++) {
            if(this.audioData[i] > maxVal) { maxVal = this.audioData[i]; maxIdx = i; }
        }
        const freq = maxIdx * this.audioCtx.sampleRate / this.analyser.fftSize;

        // 2. SEXTANT STELLARUM (SLAM)
        this.ctxSlam.drawImage(document.getElementById('cam-preview'), 0, 0, this.canvasSlam.width, this.canvasSlam.height);
        const frame = this.ctxSlam.getImageData(0,0,this.canvasSlam.width, this.canvasSlam.height);
        let flux = 0, pts = 0;
        
        if(this.state.lastPixels) {
            for(let i=0; i<frame.data.length; i+=800) { // Précision accrue
                const diff = Math.abs(frame.data[i] - this.state.lastPixels[i]);
                flux += diff;
                if(frame.data[i] > 220) { // Détection d'Astres
                    pts++;
                    if(pts < 30) { // Rendu LIDAR
                        this.ctxSlam.fillStyle = "cyan";
                        this.ctxSlam.fillRect((i/4)%this.canvasSlam.width, (i/4)/this.canvasSlam.width, 3, 3);
                    }
                }
            }
        }
        this.state.lastPixels = frame.data;

        // 3. FUSION CAUSALE
        const targetSpeed = freq * this.state.ratio;
        this.state.speed += (targetSpeed - this.state.speed) * 0.15;
        this.state.coherenceScore = (flux < 10 && freq > 100) ? 20 : 100;

        // 4. INTÉGRATION TEMPORELLE (PLANCK-LEVEL)
        const planckStep = math.multiply(math.bignumber(dt), this.const.invTp);
        this.state.planck = math.add(this.state.planck, planckStep);
        this.state.pos = math.add(this.state.pos, math.multiply(this.state.speed / 3.6, dt));

        this.updateHUD(freq, flux, pts);
        this.drawAudioViz();
        requestAnimationFrame(() => this.loop());
    },

    updateHUD(f, fl, pt) {
        document.getElementById('ui-speed').innerText = this.state.speed.toFixed(2);
        document.getElementById('ui-freq').innerText = Math.round(f) + " Hz";
        document.getElementById('ui-pts').innerText = pt;
        document.getElementById('ui-coh').innerText = this.state.coherenceScore + "%";
        document.getElementById('ui-g').innerText = this.state.gVector.toFixed(3) + " G";
        document.getElementById('ui-coord').innerText = "X: " + math.format(this.state.pos, {notation: 'fixed', precision: 24});
        document.getElementById('ui-planck').innerText = math.format(this.state.planck, {notation: 'fixed', precision: 0});
        
        const veto = document.getElementById('ui-veto');
        veto.innerText = this.state.coherenceScore < 50 ? "SIM_DETECTED" : "OPTIMAL";
        veto.style.color = this.state.coherenceScore < 50 ? "var(--crit)" : "var(--glow)";
    },

    log(m, crit=false) {
        const c = document.getElementById('log-console');
        c.innerHTML = `<span style="color:${crit?'var(--crit)':'var(--glow)'}">> ${m}</span><br>` + c.innerHTML;
    },

    drawAudioViz() {
        const ctx = this.ctxAudio, w = this.canvasAudio.width, h = this.canvasAudio.height;
        ctx.clearRect(0,0,w,h);
        ctx.fillStyle = '#00ff88';
        for(let i=0; i<this.audioData.length; i+=10) {
            const hBar = (this.audioData[i]/255)*h;
            ctx.fillRect(i, h-hBar, 4, hBar);
        }
    }
};
                        </script>
