<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ARCHÈ V1200 | ULTIMA SOUVERAIN</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <style>
        :root { --neon: #00ffcc; --gold: #ffd700; --bg: #000b0d; }
        body { background: var(--bg); color: var(--neon); font-family: 'Consolas', monospace; margin: 0; overflow: hidden; }
        .v-master { font-size: 110px; text-align: center; color: #fff; font-weight: 900; padding: 15px 0; text-shadow: 0 0 50px var(--neon); }
        .hud-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; height: 350px; }
        .module { border: 1px solid #1a4a4a; background: rgba(0, 20, 30, 0.9); padding: 10px; position: relative; }
        .label { font-size: 9px; color: var(--gold); text-transform: uppercase; letter-spacing: 2px; display: block; margin-bottom: 5px; }
        #sonar-wave { width: 100%; height: 60px; background: #001a1a; border: 1px solid #1a4a4a; }
        .black-box { font-size: 10px; color: #55aaaa; height: 60px; overflow: hidden; border-top: 1px solid #1a4a4a; padding-top: 5px; }
    </style>
</head>
<body>

<div class="v-master" id="v-val">0.000000</div>
<div style="text-align: center; font-size: 12px; margin-top: -40px; color: var(--neon); letter-spacing: 3px;">VITESSE ABSOLUE RÉCURSIVE (m/s)</div>

<div class="hud-container">
    <div class="module">
        <span class="label">Scanner de Structure (Voxel-Flow)</span>
        <video id="cam-abyss" style="width:100%; height:120px; object-fit:cover; opacity:0.6;" autoplay playsinline muted></video>
        <div class="black-box" id="sys-log">> INITIALISATION DU SCELLAGE...</div>
    </div>
    
    <div class="module">
        <span class="label">Sondeur Acoustique (Sonar)</span>
        <canvas id="sonar-wave"></canvas>
        <div style="margin-top:10px; font-size:11px;">
            Dureté Paroi: <span id="wall-type">CALCUL...</span><br>
            Écho-Délai: <span id="echo-ms">--</span> ms<br>
            Densité Fluide: <span id="rho-val">1025</span> kg/m³
        </div>
    </div>
</div>

<button onclick="ArcheFinal.ignite()" id="btn-start" style="width: 100%; padding: 30px; background: var(--neon); color: #000; border: none; font-weight: bold; cursor: pointer; font-size: 18px;">
    SCELLER LA VÉRITÉ PHYSIQUE
</button>

<script>
const m = math;
m.config({ number: 'BigNumber', precision: 64 });
const _BN = (n) => m.bignumber(String(n || 0));

const ArcheFinal = {
    state: {
        v: _BN(0),
        lastT: performance.now(),
        integrity: 100,
        audioContext: null,
        analyser: null
    },

    async ignite() {
        document.getElementById('btn-start').style.display = 'none';
        
        // 1. Accès Caméra (SLAM)
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: true });
        document.getElementById('cam-abyss').srcObject = stream;

        // 2. Accès Audio (Sonar)
        this.state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = this.state.audioContext.createMediaStreamSource(stream);
        this.state.analyser = this.state.audioContext.createAnalyser();
        source.connect(this.state.analyser);

        this.run();
    },

    run() {
        const canvas = document.getElementById('sonar-wave');
        const ctx = canvas.getContext('2d');
        const bufferLength = this.state.analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        const update = () => {
            const now = performance.now();
            const dt = _BN((now - this.state.lastT) / 1000);
            this.state.lastT = now;

            // Analyse spectrale pour détecter la "dureté" de l'environnement
            this.state.analyser.getByteFrequencyData(dataArray);
            let avgFreq = dataArray.reduce((a, b) => a + b) / bufferLength;
            
            // Correction de vitesse par densité (Acoustique)
            if(avgFreq > 50) document.getElementById('wall-type').innerText = "ROCHE / DUR";
            else document.getElementById('wall-type').innerText = "SABLE / MOU";

            // Mise à jour UI
            this.drawSonar(ctx, dataArray, bufferLength);
            requestAnimationFrame(update);
        };
        
        window.addEventListener('devicemotion', (e) => {
            let acc = _BN(e.acceleration.x || 0);
            this.state.v = m.add(this.state.v, m.multiply(acc, 0.016)); // Intégration simplifiée 60Hz
            document.getElementById('v-val').innerText = m.abs(this.state.v).toFixed(6);
        });

        update();
    },

    drawSonar(ctx, data, len) {
        ctx.clearRect(0, 0, 300, 60);
        ctx.strokeStyle = '#00ffcc';
        ctx.beginPath();
        let sliceWidth = 300 / len;
        let x = 0;
        for(let i = 0; i < len; i++) {
            let v = data[i] / 128.0;
            let y = v * 30;
            if(i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            x += sliceWidth;
        }
        ctx.stroke();
    }
};
</script>
</body>
</html>
