<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OMNISCIENCE V82 • ULTIMA ARCHE</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <style>
        :root { --ion: #00ffcc; --path: #ffaa00; --bg: #000; --err: #ff0055; --active: #00ff00; --panel: rgba(5,10,10,0.98); }
        * { box-sizing: border-box; font-family: 'JetBrains Mono', monospace; }
        body { margin: 0; background: var(--bg); color: var(--ion); overflow: hidden; height: 100vh; font-size: 11px; }
        
        #map { position: fixed; inset: 0; filter: invert(1) hue-rotate(180deg) brightness(0.2) contrast(1.2); z-index: 0; }
        #canvas-path { position: fixed; inset: 0; z-index: 1; pointer-events: none; }

        .hud { position: fixed; inset: 15px; display: grid; grid-template-columns: 300px 1fr 300px; grid-template-rows: auto 1fr auto; gap: 15px; pointer-events: none; z-index: 100; }
        .panel { background: var(--panel); border: 1px solid var(--ion); padding: 12px; pointer-events: auto; backdrop-filter: blur(10px); }
        
        .title { font-size: 0.7rem; font-weight: 900; letter-spacing: 2px; border-bottom: 1px solid var(--ion); margin-bottom: 8px; padding-bottom: 4px; display: flex; justify-content: space-between; }
        .data { display: flex; justify-content: space-between; align-items: center; margin: 4px 0; }
        .val { color: #fff; font-weight: bold; font-size: 1.1rem; font-variant-numeric: tabular-nums; }
        
        .indicator { width: 8px; height: 8px; border-radius: 50%; display: inline-block; background: #333; margin-right: 5px; }
        .on { background: var(--active); box-shadow: 0 0 8px var(--active); }
        
        .btn { background: var(--ion); color: #000; border: none; padding: 10px; cursor: pointer; font-weight: 900; width: 100%; transition: 0.2s; text-transform: uppercase; }
        .btn:active { transform: scale(0.95); }
        
        #boot { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="map"></div>
<canvas id="canvas-path"></canvas>

<div id="boot">
    <h1 style="letter-spacing: 12px;">ARCHE_V82</h1>
    <p style="opacity: 0.5;">SOUVEREIGN KINETIC ENGINE • S10e OPTIMIZED</p>
    <button class="btn" style="width: auto; padding: 15px 40px;" onclick="CORE.ignite()">SYNC SENSOR LINK</button>
</div>

<div class="hud">
    <div class="panel">
        <div class="title">SYSTEM STATUS</div>
        <div class="data">BAROMÈTRE <span id="st-baro" class="indicator"></span></div>
        <div class="data">GYRO/ACCEL <span id="st-kin" class="indicator"></span></div>
        <hr style="border: 0.5px solid #222; margin: 10px 0;">
        <div class="data">TEMP BATT <span class="val" id="v-temp">--</span>°C</div>
        <div id="v-phys" style="color: var(--active); font-size: 0.6rem;">ÉTAT: SEC / STABLE</div>
    </div>

    <div></div>

    <div class="panel">
        <div class="title">VERTICAL SLAM</div>
        <div class="data">ALTITUDE <span class="val" id="v-alt">0.0</span> m</div>
        <div class="data">PRESSION <span id="v-pres">----</span> hPa</div>
        <button class="btn" style="font-size: 0.6rem; padding: 4px;" onclick="CORE.calibrate()">CALIBRER ZÉRO LOCAL</button>
    </div>

    <div class="panel" style="grid-row: 3;">
        <div class="title">KINETIC VECTOR</div>
        <div class="data">G-FORCE <span class="val" id="v-g">1.00</span></div>
        <div class="data">V-SPEED <span class="val" id="v-speed">0.0</span> km/h</div>
        <div id="v-mode" style="color: var(--path);">MODE: NOMINAL</div>
    </div>

    <div class="panel" style="grid-row: 3;">
        <div class="title">MISSION LOG</div>
        <div class="data">DIST TOTAL <span class="val" id="v-dist">0.0</span> m</div>
        <button class="btn" onclick="ARCHIVE.download()">EXPORT MISSION .REAL</button>
    </div>
</div>

<script>
const CORE = {
    active: false, pos: {x:0, y:0, z:0}, vel: {x:0, y:0, z:0},
    p0: 1013.25, lastT: performance.now(), distance: 0,
    path: [{x:0, y:0}],

    async ignite() {
        if (window.DeviceMotionEvent?.requestPermission) await DeviceMotionEvent.requestPermission();
        document.getElementById('boot').style.display = 'none';
        
        // Init Baromètre (S10e Chrome Flags requis)
        if ('PressureSensor' in window) {
            const baro = new PressureSensor({frequency: 10});
            baro.onreading = () => this.updateBaro(baro.pressure);
            baro.start();
            document.getElementById('st-baro').classList.add('on');
        }

        // Init Mouvement
        window.addEventListener('devicemotion', e => this.compute(e));
        document.getElementById('st-kin').classList.add('on');
        
        // Init Battery (Physique)
        if (navigator.getBattery) {
            navigator.getBattery().then(b => {
                setInterval(() => {
                    const temp = b.temp || 22; // Fallback
                    document.getElementById('v-temp').innerText = temp;
                    if(temp < 15 && this.pos.z < -2) {
                        document.getElementById('v-phys').innerText = "⚠️ CONDENSATION POSSIBLE";
                        document.getElementById('v-phys').style.color = "var(--err)";
                    }
                }, 5000);
            });
        }

        MAP_ENGINE.init();
        this.active = true;
        this.render();
    },

    calibrate() {
        this.p0 = this.currentP || 1013.25;
        this.pos.z = 0;
        alert("Zéro local défini sur " + this.p0 + " hPa");
    },

    updateBaro(p) {
        this.currentP = p;
        // Formule de Laplace simplifiée
        this.pos.z = 44330 * (1 - Math.pow(p / this.p0, 1/5.255));
        document.getElementById('v-alt').innerText = this.pos.z.toFixed(1);
        document.getElementById('v-pres').innerText = p.toFixed(2);
    },

    compute(e) {
        if(!this.active) return;
        const now = performance.now();
        const dt = (now - this.lastT) / 1000;
        this.lastT = now;

        const acc = e.acceleration;
        const gAcc = e.accelerationIncludingGravity;
        
        // G-Force réelle (Manèges)
        const gForce = Math.sqrt(gAcc.x**2 + gAcc.y**2 + gAcc.z**2) / 9.81;
        document.getElementById('v-g').innerText = gForce.toFixed(2);

        // Détection Salto
        const rot = e.rotationRate;
        if(Math.abs(rot.alpha) > 200 || Math.abs(rot.beta) > 200) {
            document.getElementById('v-mode').innerText = "MODE: KINETIC (SALTO)";
        } else {
            document.getElementById('v-mode').innerText = "MODE: NOMINAL";
        }

        // Intégration 2D (Fil d'Ariane)
        // On utilise la force linéaire brute filtrée
        if(Math.abs(acc.y) > 0.2) {
            this.vel.y += acc.y * dt;
            this.distance += Math.abs(this.vel.y * dt);
            
            const last = this.path[this.path.length - 1];
            this.path.push({
                x: last.x + (acc.x * dt),
                y: last.y + (acc.y * dt)
            });
            if(this.path.length > 2000) this.path.shift();
        }

        document.getElementById('v-speed').innerText = (Math.abs(this.vel.y) * 3.6).toFixed(1);
        document.getElementById('v-dist').innerText = this.distance.toFixed(1);
    },

    render() {
        const c = document.getElementById('canvas-path'), ctx = c.getContext('2d');
        c.width = window.innerWidth; c.height = window.innerHeight;
        const draw = () => {
            ctx.clearRect(0,0,c.width, c.height);
            ctx.strokeStyle = '#00ffcc'; ctx.lineWidth = 2;
            ctx.beginPath();
            const cx = c.width/2, cy = c.height/2;
            this.path.forEach((p, i) => {
                const sx = cx + p.x * 50, sy = cy + p.y * 50;
                if(i === 0) ctx.moveTo(sx, sy); else ctx.lineTo(sx, sy);
            });
            ctx.stroke();
            requestAnimationFrame(draw);
        };
        draw();
    }
};

const MAP_ENGINE = {
    init() {
        const m = L.map('map', {zoomControl: false, attributionControl: false}).setView([43.2965, 5.3698], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(m);
    }
};

const ARCHIVE = {
    download() {
        const data = { mission: "ARCHE_V82", dist: CORE.distance, path: CORE.path, alt_final: CORE.pos.z };
        const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `MISSION_DATA.REAL`;
        a.click();
    }
};
</script>
</body>
</html>
