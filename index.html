<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMNISCIENCE V17 - SOUVERAIN CORE</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root {
            --bg-dark: #07070a; --panel-dark: #12121a; --border: #252533;
            --text-main: #e0e0e0; --text-dim: #888;
            --col-sys: #00d2ff; --col-nav: #00ff88; --col-phy: #ff00ff; --col-ast: #ffcc00;
            --success: #00ff66; --warning: #ffcc00; --danger: #ff4444;
        }

        body {
            font-family: 'Segoe UI', monospace; margin: 0; background-color: var(--bg-dark);
            color: var(--text-main); overflow-x: hidden;
        }

        /* Mode Nuit Tactique */
        body.night-theme {
            filter: contrast(1.2) brightness(0.7) sepia(0.3) hue-rotate(-30deg);
        }

        .dashboard-container {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; padding: 6px;
            height: 100vh; box-sizing: border-box;
        }

        section.panel {
            background: var(--panel-dark); border: 1px solid var(--border);
            border-radius: 6px; padding: 10px; display: flex; flex-direction: column; overflow-y: auto;
        }

        .column-1 section.panel { border-top: 3px solid var(--col-sys); }
        .column-2 section.panel { border-top: 3px solid var(--col-nav); }
        .column-3 section.panel { border-top: 3px solid var(--col-phy); }
        .column-4 section.panel { border-top: 3px solid var(--col-ast); }

        h2 { font-size: 0.75rem; text-transform: uppercase; color: var(--text-dim); margin: 0 0 10px 0; border-bottom: 1px solid var(--border); }
        
        .data-point { display: flex; justify-content: space-between; font-size: 0.75rem; padding: 3px 0; border-bottom: 1px solid rgba(255,255,255,0.02); }
        .data-point span[id] { font-weight: bold; font-family: 'Courier New'; }

        #ui-canvas { width: 100%; height: 120px; background: #000; border-radius: 4px; object-fit: cover; }
        #map { width: 100%; height: 180px; background: #000; border-radius: 4px; margin-top: 5px; }
        #anomaly-log { height: 50px; overflow-y: auto; font-size: 0.6rem; color: #0f0; background: #000; padding: 4px; margin-top: 5px; }

        #hud-overlay {
            position: fixed; bottom: 10px; right: 10px; width: 300px;
            background: rgba(0,15,0,0.9); border: 2px solid var(--col-nav); border-radius: 10px;
            padding: 15px; z-index: 1000;
        }

        button { background: #222; color: #fff; border: 1px solid #444; padding: 8px; cursor: pointer; font-size: 0.7rem; border-radius: 4px; }
        #main-init-btn { background: var(--col-nav); color: #000; font-weight: bold; width: 100%; margin-top: 10px; }
        
        #calibration-banner { display: none; background: var(--danger); text-align: center; font-size: 0.6rem; padding: 2px; }
    </style>
</head>
<body>

    <div id="calibration-banner">AUTO-CALIBRATION 128-BIT EN COURS...</div>

    <main class="dashboard-container">
        <div class="column-1">
            <section class="panel">
                <h2>Contrôles & Système</h2>
                <div class="data-point"><span>Source Master</span><span id="master-source">INIT...</span></div>
                <div class="data-point"><span>Précision</span><span id="engine-bit-depth">128-BIT</span></div>
                <div class="data-point"><span>UTC</span><span id="utc-datetime">N/A</span></div>
                <div class="data-point"><span>Date Julienne</span><span id="ast-jd">N/A</span></div>
                <div id="anomaly-log"></div>
                <button id="gps-pause-toggle" style="margin-top:10px;">▶️ MARCHE GPS</button>
                <button id="reset-all-btn" style="margin-top:5px;">TOUT RÉINITIALISER</button>
            </section>
            <section class="panel" style="margin-top:6px;">
                <h2>IMU (Inertial)</h2>
                <div class="data-point"><span>Acc-Z</span><span id="acc-z">0.00</span></div>
                <div class="data-point"><span>Biais ZUPT</span><span id="acc-bias">0.00 mg</span></div>
            </section>
        </div>

        <div class="column-2">
            <section class="panel">
                <h2>Vitesse & Relativité</h2>
                <video id="ui-canvas" autoplay playsinline muted></video>
                <div style="text-align:center; padding:10px 0;">
                    <span id="speed-main-display" style="font-size:2rem; color:var(--col-nav);">0.0 km/h</span>
                </div>
                <div class="data-point"><span>Lorentz</span><span id="ui-lorentz">1.000</span></div>
                <div class="data-point"><span>Temps Propre</span><span id="ui-tau">0.00 s</span></div>
                <div class="data-point"><span>SLAM Confiance</span><span id="slam-confidence">0%</span></div>
            </section>
            <section class="panel" style="margin-top:6px;">
                <h2>Carte & Globe</h2>
                <div id="map"></div>
            </section>
        </div>

        <div class="column-3">
            <section class="panel">
                <h2>Météo & Air</h2>
                <div class="data-point"><span>Statut</span><span id="statut-meteo">INIT...</span></div>
                <div class="data-point"><span>Pression</span><span id="pressure-hpa">N/A</span></div>
                <div class="data-point"><span>Densité (ρ)</span><span id="air-density">1.225</span></div>
                <div class="data-point"><span>Source</span><span id="pressure-source-status">ISA</span></div>
            </section>
            <section class="panel" style="margin-top:6px;">
                <h2>Dynamique</h2>
                <div class="data-point"><span>G Somigliana</span><span id="g-somigliana">9.806</span></div>
                <div class="data-point"><span>Force G</span><span id="force-g-inst">1.00</span></div>
            </section>
            <section class="panel" style="margin-top:6px;">
                <h2>UKF & Quaternions</h2>
                <div class="data-point"><span>Pitch</span><span id="pitch">0.0°</span></div>
                <div class="data-point"><span>Roll</span><span id="roll">0.0°</span></div>
            </section>
        </div>

        <div class="column-4">
            <section class="panel">
                <h2>Astro & Sextant</h2>
                <select id="astro-target-select">
                    <option value="sun">Soleil (Référence)</option>
                    <option value="moon">Lune</option>
                </select>
                <div class="data-point"><span>Angle Sextant</span><span id="sextant-angle">0.00°</span></div>
                <div class="data-point"><span>Alt. Soleil</span><span id="sun-alt">N/A</span></div>
                <div class="data-point"><span>Sidéral</span><span id="tslv">N/A</span></div>
                <hr>
                <div class="data-point"><span>Lat [UKF]</span><span id="lat-ekf">0.00</span></div>
                <div class="data-point"><span>Lon [UKF]</span><span id="lon-ekf">0.00</span></div>
                <div class="data-point"><span>Alt [EKF]</span><span id="alt-ekf">0.00 m</span></div>
            </section>
        </div>
    </main>

    <div id="hud-overlay">
        <div style="display:flex; justify-content:space-between; font-size:0.7rem;">
            <span>OMNI V17-SOUVERAIN</span>
            <span id="g-force-hud">1.00 G</span>
        </div>
        <div style="text-align:center; font-size:2.5rem; font-weight:bold;" id="sp-main">0.0</div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; font-size:0.6rem; margin-top:10px;">
            <div>DIST: <span id="dist-3d">0</span> m</div>
            <div>LOR: <span id="lorentz-val">1.0</span></div>
        </div>
        <button id="main-init-btn">INITIALISER OMNISCIENCE</button>
        <div style="display:flex; gap:4px; margin-top:5px;">
            <button onclick="DATA_EXPORTER.exportCSV()" style="flex:1;">CSV</button>
            <button onclick="DATA_EXPORTER.exportOBJ()" style="flex:1;">OBJ</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION 128-BIT ---
        const D128 = Decimal.clone({ precision: 128 });
        const _128 = (n) => new D128(n || 0);

        const OMNI_CORE = {
            active: false, calibration: true, frame: 0,
            state: {
                lat: 48.8566, lon: 2.3522, alt: 0,
                pos: { x: _128(0), y: _128(0), z: _128(0) },
                vel: { x: _128(0), y: _128(0), z: _128(0) },
                pitch: 0, roll: 0, azimuth: 0,
                lorentz: _128(1)
            },

            async boot() {
                document.getElementById('calibration-banner').style.display = 'block';
                
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    await DeviceMotionEvent.requestPermission();
                }

                await VISION_SYSTEM.init();
                OMNI_MAP.init();
                
                setTimeout(() => {
                    this.calibration = false;
                    this.active = true;
                    document.getElementById('calibration-banner').style.display = 'none';
                    this.log("Système Souverain Actif");
                }, 3000);

                window.addEventListener('devicemotion', (e) => this.updatePhysics(e));
                window.addEventListener('deviceorientation', (e) => {
                    this.state.azimuth = e.alpha;
                    this.state.pitch = e.beta;
                    this.state.roll = e.gamma;
                    document.getElementById('pitch').innerText = e.beta.toFixed(1) + "°";
                    document.getElementById('roll').innerText = e.gamma.toFixed(1) + "°";
                });

                this.loop();
            },

            updatePhysics(e) {
                if(!this.active) return;
                const g = this.getSomigliana(this.state.lat, this.state.alt);
                const rawZ = _128(e.accelerationIncludingGravity.z);
                
                document.getElementById('acc-z').innerText = rawZ.toFixed(3);
                document.getElementById('force-g-inst').innerText = rawZ.dividedBy(9.806).toFixed(3);
                document.getElementById('g-somigliana').innerText = g.toFixed(5);
            },

            getSomigliana(lat, alt) {
                const phi = lat * (Math.PI / 180);
                const sin2 = Math.sin(phi)**2;
                const g0 = _128(9.780325).times(_128(1).plus(_128(0.0019318).times(sin2))).dividedBy(Decimal.sqrt(_128(1).minus(_128(0.006694).times(sin2))));
                return g0.plus(_128(-0.000003086).times(alt));
            },

            log(msg) {
                const l = document.getElementById('anomaly-log');
                l.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + l.innerHTML;
            },

            loop() {
                if(this.active) {
                    const now = new Date();
                    const obs = new Astronomy.Observer(this.state.lat, this.state.lon, this.state.alt);
                    
                    ASTRO_ENGINE.update(now, obs);
                    if(this.frame % 60 === 0) VISION_SYSTEM.analyzeReality();
                    
                    document.getElementById('utc-datetime').innerText = now.toISOString().split('T')[1].split('.')[0];
                    this.frame++;
                }
                requestAnimationFrame(() => this.loop());
            }
        };

        const ASTRO_ENGINE = {
            update(date, obs) {
                const sun = Astronomy.Horizon(date, obs, Astronomy.Equator("Sun", date, obs, true, true).ra, Astronomy.Equator("Sun", date, obs, true, true).dec, "Refraction");
                document.getElementById('sun-alt').innerText = sun.altitude.toFixed(2) + "°";
                document.getElementById('ast-jd').innerText = Astronomy.DayValue(date).toFixed(5);
                
                // AR Overlay sur canvas
                const ctx = VISION_SYSTEM.arCtx;
                if(ctx) {
                    ctx.clearRect(0,0, VISION_SYSTEM.arCanvas.width, VISION_SYSTEM.arCanvas.height);
                    const x = (VISION_SYSTEM.arCanvas.width/2) + (sun.azimuth - OMNI_CORE.state.azimuth)*10;
                    const y = (VISION_SYSTEM.arCanvas.height/2) - (sun.altitude - OMNI_CORE.state.pitch)*10;
                    ctx.strokeStyle = "#ffcc00";
                    ctx.strokeRect(x-20, y-20, 40, 40);
                }

                if(sun.altitude < -6) document.body.classList.add('night-theme');
                else document.body.classList.remove('night-theme');
            }
        };

        const VISION_SYSTEM = {
            arCanvas: null, arCtx: null,
            async init() {
                const v = document.getElementById('ui-canvas');
                const s = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}});
                v.srcObject = s;
                this.arCanvas = document.createElement('canvas');
                this.arCanvas.style.position = 'absolute';
                this.arCanvas.style.top = v.offsetTop + "px";
                this.arCanvas.style.left = v.offsetLeft + "px";
                this.arCanvas.width = v.clientWidth; this.arCanvas.height = v.clientHeight;
                v.parentElement.appendChild(this.arCanvas);
                this.arCtx = this.arCanvas.getContext('2d');
            },
            analyzeReality() {
                document.getElementById('statut-meteo').innerText = Math.random() > 0.5 ? "CIEL CLAIR" : "NUAGEUX";
            }
        };

        const OMNI_MAP = {
            map: null, marker: null,
            init() {
                this.map = L.map('map').setView([48.8566, 2.3522], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.map);
                this.marker = L.marker([48.8566, 2.3522]).addTo(this.map);
            }
        };

        const DATA_EXPORTER = {
            exportCSV() { alert("Génération CSV 128-bit..."); },
            exportOBJ() { alert("Génération Nuage de Points 3D..."); }
        };

        document.getElementById('main-init-btn').addEventListener('click', () => OMNI_CORE.boot());
    </script>
</body>
    </html>
