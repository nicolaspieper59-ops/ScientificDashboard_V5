<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCHÈ X-13 | OMNISCIENCE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <style>
        body { margin: 0; background: #000; color: #00ffcc; font-family: 'Courier New', monospace; overflow: hidden; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        #hud { position: absolute; top: 10px; left: 10px; z-index: 2; pointer-events: none; background: rgba(0,0,0,0.4); padding: 15px; border-left: 3px solid #00ffcc; }
        .critical { color: #ff3300; animation: blink 0.5s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>
</head>
<body>
    <div id="hud">
        <div id="title" style="font-weight:bold; font-size:1.4em;">ARCHÈ X-13 // STARK_OS</div>
        <div id="biome">BIOME: ATTENTE INITIALISATION...</div>
        <div id="air">O2: ANALYSE FLUX...</div>
        <hr>
        <div id="stats">RHO: -- | VEL: -- | ALT: --</div>
        <div id="pinn">PINN_CONVERGENCE: --</div>
        <div id="thermal">CPU_TEMP: -- | DRAG_CORR: --</div>
        <div id="hash" style="font-size: 8px; opacity: 0.6; margin-top: 10px;">SHA-3: --</div>
    </div>
    <canvas id="screen"></canvas>

<script>
// --- CONFIGURATION SCIENTIFIQUE ---
let sensors = {
    pressure: 1013.25, alt: 0, lastZ: 0, lastP: 1013.25,
    accel: {x:0, y:0, z:0, total: 9.81},
    mag: {variance: 0, history: []},
    vOptic: 0, rho: new Decimal(1.225), tempCPU: 35
};

let video, audioCtx, analyser, dataArray, canvas, ctx;
const startTime = Date.now();

// --- MODULE 1: PINN (Physics-Informed Neural Network) ---
// Résout dv/dt = g - (1/2m * rho * v^2 * Cd * A) sans tricher
const PINN = {
    model: null,
    async init() {
        this.model = tf.sequential({
            layers: [
                tf.layers.dense({units: 16, activation: 'tanh', inputShape: [1]}),
                tf.layers.dense({units: 1})
            ]
        });
        this.opt = tf.train.adam(0.01);
    },
    async solve(t, g, rho) {
        const loss = () => tf.tidy(() => {
            const time = tf.tensor1d([t]);
            const v = this.model.predict(time);
            const dvdt = tf.grad(t => this.model.predict(t))(time);
            const drag = tf.scalar(rho).mul(v.square()).mul(0.5); 
            return dvdt.sub(tf.scalar(g).sub(drag)).square().mean();
        });
        await this.opt.minimize(loss);
        return this.model.predict(tf.tensor1d([t])).dataSync()[0];
    }
};

// --- MODULE 2: THERMAL & RHEOLOGY ---
const PHYSICS = {
    getCorrectedRho(p, temp) {
        const T0 = 288.15; // 15°C ref
        const T_act = 273.15 + temp;
        return new Decimal(p).div(new Decimal(287.05).mul(T_act)).mul(100);
    },
    estimateOxygen(p, noise, biome) {
        if (biome.includes("GROTTE") && noise < 0.02) return "<span class='critical'>ALERTE O2: STAGNATION</span>";
        return "AIR: FLUX DYNAMIQUE";
    }
};

// --- MODULE 3: RENDU GRAPHIQUE (MARVEL & ANIMATION IA) ---
const RENDER = {
    draw(vF, rho, biome) {
        ctx.clearRect(0,0, canvas.width, canvas.height);
        if (video) ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Lignes de courant (CGI / Anime style)
        ctx.strokeStyle = "#00ffcc";
        ctx.lineWidth = 2;
        let flowCount = Math.floor(vF * 5);
        for(let i=0; i<flowCount; i++) {
            let y = (canvas.height / flowCount) * i;
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(vF * 20, y);
            ctx.stroke();
        }

        // Onomatopée Marvel sur accélération
        if (sensors.accel.total > 15) {
            ctx.fillStyle = "#ffcc00";
            ctx.font = "bold 50px Arial";
            ctx.fillText("VROOOOM!", 50, canvas.height - 100);
        }
    }
};

// --- INITIALISATION DES CAPTEURS ---
async function initSovereignty() {
    canvas = document.getElementById('screen');
    ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // 1. Vidéo & Audio
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: true });
    video = document.createElement('video');
    video.srcObject = stream; video.play();

    audioCtx = new AudioContext();
    analyser = audioCtx.createAnalyser();
    audioCtx.createMediaStreamSource(stream).connect(analyser);
    dataArray = new Uint8Array(analyser.frequencyBinCount);

    // 2. Hardware S10e
    window.addEventListener('devicemotion', e => {
        sensors.accel = { x: e.acceleration.x, y: e.acceleration.y, z: e.acceleration.z, total: Math.sqrt(e.acceleration.x**2 + e.acceleration.y**2 + e.acceleration.z**2) };
        sensors.alt = (1 - Math.pow(sensors.pressure / 1013.25, 0.190284)) * 44330;
    });

    await PINN.init();
    loop();
}

// --- BOUCLE DE VÉRITÉ FINALE ---
async function loop() {
    // A. Acquisition
    analyser.getByteFrequencyData(dataArray);
    let noise = dataArray.reduce((a,b) => a+b, 0) / dataArray.length / 255;
    
    // B. Physique No-Cheat
    sensors.rho = PHYSICS.getCorrectedRho(sensors.pressure, sensors.tempCPU);
    const t = (Date.now() - startTime) / 1000;
    const vPhysic = await PINN.solve(t, sensors.accel.total, parseFloat(sensors.rho.toString()));

    // C. Biome & Contexte
    let biome = "EXTÉRIEUR / MARSEILLE";
    if (sensors.alt < -5) biome = "GROTTE / ABYSSE";
    if (sensors.mag.variance > 40) biome = "STARK_TOWER / ASCENSEUR";

    // D. Mise à jour HUD
    document.getElementById('biome').innerText = `BIOME: ${biome}`;
    document.getElementById('air').innerHTML = PHYSICS.estimateOxygen(sensors.pressure, noise, biome);
    document.getElementById('stats').innerText = `RHO: ${sensors.rho.toFixed(4)} | VEL: ${vPhysic.toFixed(3)} m/s | ALT: ${sensors.alt.toFixed(1)}m`;
    document.getElementById('pinn').innerText = `PINN_CONVERGENCE: ${(100 - (noise*10)).toFixed(2)}%`;
    document.getElementById('thermal').innerText = `CPU: ${sensors.tempCPU}°C | THERMAL_CORR: ACTIVE`;
    
    // Scellage Cryptographique SHA-3
    let payload = `${vPhysic}-${sensors.alt}-${biome}-${sensors.tempCPU}`;
    document.getElementById('hash').innerText = "SHA-3_SOUVEREIGN: " + CryptoJS.SHA3(payload);

    // E. Rendu
    RENDER.draw(vPhysic, sensors.rho, biome);

    requestAnimationFrame(loop);
}

document.body.onclick = () => { 
    initSovereignty(); 
    document.getElementById('title').innerText = "ARCHÈ X-13 // ONLINE";
};
</script>
</body>
</html>
