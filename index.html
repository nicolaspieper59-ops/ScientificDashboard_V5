<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ARCHÈ X-13 | OMNISCIENCE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <script src="lib/ephem.js"></script> <style>
        body { margin: 0; background: #000; color: #00ffcc; font-family: 'Courier New', monospace; }
        #log { position: absolute; bottom: 10px; left: 10px; font-size: 10px; width: 95%; overflow: hidden; }
        .critical { color: #ff3300; }
    </style>
</head>
<body>
    <div id="hud">
        <h2>SINGULARITY ENGINE v10.0</h2>
        <div id="biome">BIOME: INITIALISATION...</div>
        <div id="stats">RHO: -- | CORIOLIS: -- | REYNOLDS: --</div>
        <div id="hash">SHA-3: --</div>
    </div>
    <canvas id="view"></canvas>
    <div id="log"></div>

<script>
const ENGINE = {
    rho: new Decimal(1.225),
    lastP: null,
    lastZ: 0,
    vF: 0,
    lat: 0.755, // Marseille en Radian

    // 1. AUTARCIE PHYSIQUE (Calcul de rho sans weather.js)
    updateFluids(currentP, currentZ) {
        if (this.lastP && Math.abs(currentZ - this.lastZ) > 0.05) {
            const dP = new Decimal(currentP).minus(this.lastP);
            const dZ = new Decimal(currentZ).minus(this.lastZ);
            // Loi Hydrostatique : rho = - (1/g) * (dP/dZ)
            const calculatedRho = dP.div(dZ.mul(9.80665)).abs();
            if (calculatedRho.gt(0.5) && calculatedRho.lt(1200)) {
                this.rho = calculatedRho;
            }
        }
        this.lastP = currentP;
        this.lastZ = currentZ;
    },

    // 2. RÉFÉRENTIEL RELATIVISTE (Coriolis & Eötvös)
    getRelativity(vX) {
        const Omega = 0.000072921; 
        // Effet Eötvös (poids apparent)
        return new Decimal(2).mul(Omega).mul(vX).mul(Math.cos(this.lat));
    },

    // 3. AUTO-BIOME (Détection environnementale)
    detectContext(accel, mag, noise) {
        if (mag.variance > 40) return "ASCENSEUR / MÉTAL";
        if (accel.total > 35) return "TRIDENT / BALISTIQUE";
        if (noise > 0.7 && this.rho.gt(800)) return "SOUS-MARIN / LIQUIDE";
        if (noise > 0.7) return "VOL ÉLYTRES / FRICTION";
        return "MODE STANDARD";
    }
};

// INITIALISATION DES CAPTEURS S10e
let audioCtx, analyser, dataArray;
async function initAudio() {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    source.connect(analyser);
    dataArray = new Uint8Array(analyser.frequencyBinCount);
}

// BOUCLE DE VÉRITÉ ABSOLUE
function coreLoop() {
    if (analyser) {
        analyser.getByteFrequencyData(dataArray);
        const noise = dataArray.reduce((a,b) => a+b, 0) / dataArray.length;
        
        // Calcul Friction Air/Eau (Rhéologie)
        ENGINE.vF = Math.sqrt(noise * 0.1); 
        
        // Mise à jour Fluides
        ENGINE.updateFluids(sensors.pressure, sensors.alt);

        // Biome
        const biome = ENGINE.detectContext(sensors.accel, sensors.mag, noise);
        
        // Affichage & Scellage
        const payload = {
            v: ENGINE.vF,
            rho: ENGINE.rho.toString(),
            biome: biome,
            coriolis: ENGINE.getRelativity(ENGINE.vF).toString(),
            time: Date.now()
        };

        document.getElementById('biome').innerText = `BIOME: ${biome}`;
        document.getElementById('stats').innerText = `RHO: ${ENGINE.rho.toFixed(4)} | CORIOLIS: ${payload.coriolis}`;
        document.getElementById('hash').innerText = "SHA-3: " + CryptoJS.SHA3(JSON.stringify(payload)).toString();
    }
    requestAnimationFrame(coreLoop);
}

document.body.onclick = () => { initAudio(); coreLoop(); };
</script>
</body>
</html>
