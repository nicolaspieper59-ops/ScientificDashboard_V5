<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROVIDENCE V140 • OMNI-SOUVERAIN ULTRA-CORE</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=JetBrains+Mono:wght@300;500;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #050505; --panel: #0f0f0f; --accent: #00ff88;
            --blue: #00d4ff; --gold: #ffcc00; --critical: #ff3333;
            --font-mono: 'JetBrains Mono', monospace;
        }
        body { background: var(--bg); color: #e0e0e0; font-family: var(--font-mono); margin: 0; font-size: 11px; }
        header { padding: 10px; background: #000; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .panel { background: var(--panel); border: 1px solid #222; border-top: 3px solid var(--accent); margin: 8px; padding: 10px; border-radius: 4px; }
        .panel-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-family: 'Orbitron'; font-size: 0.75rem; }
        .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .data-box { background: #151515; padding: 6px; border-radius: 2px; border-left: 2px solid #333; }
        .label { font-size: 0.55rem; color: #888; display: block; text-transform: uppercase; }
        .value { font-size: 0.95rem; color: #fff; font-weight: bold; }
        #anomaly-log { height: 60px; overflow-y: auto; background: #000; color: var(--accent); font-size: 0.6rem; padding: 5px; border: 1px solid #222; }
        .btn-main { width: 100%; padding: 12px; background: var(--accent); border: none; color: #000; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>

<header>
    <div style="font-family:'Orbitron'; color:var(--accent);">PROVIDENCE <span id="ui-version">V140-FIX</span></div>
    <div id="ui-clock" style="color:var(--blue); font-family:'Orbitron';">00:00:00</div>
</header>

<main>
    <section class="panel" style="border-top-color: var(--blue);">
        <div class="panel-header"><h2>NAV_CORE_EKF</h2><span id="ui-env-mode">STABLE</span></div>
        <div class="metrics-grid">
            <div class="data-box"><span class="label">Lat EKF</span><span class="value" id="lat-ekf">0.000000</span></div>
            <div class="data-box"><span class="label">Lon EKF</span><span class="value" id="lon-ekf">0.000000</span></div>
        </div>
    </section>

    <section class="panel" style="border-top-color: var(--accent);">
        <div class="panel-header"><h2>KINETIC_DYNAMICS</h2><span id="ui-scale-active">COMPENSATED</span></div>
        <div class="data-box" style="margin: 4px 0; border: 1px solid var(--accent); text-align:center;">
            <span class="label">Vitesse Horizontale Réelle (m/s)</span>
            <span class="value" id="vitesse-raw" style="font-size:1.8rem; color:var(--accent);">0.000000</span>
        </div>
        <div class="metrics-grid">
            <div class="data-box"><span class="label">KM/H</span><span class="value" id="speed-stable-kmh">0.00</span></div>
            <div class="data-box" style="border-left-color:var(--critical);"><span class="label">Inclinaison (Tilt)</span><span class="value" id="ui-tilt-pitch">0.00°</span></div>
            <div class="data-box"><span class="label">G-Force</span><span class="value" id="force-g-inst">1.00</span></div>
            <div class="data-box"><span class="label">Lorentz γ</span><span class="value" id="ui-lorentz">1.000000</span></div>
        </div>
    </section>

    <div class="panel">
        <div id="anomaly-log">> ATTENTE SYNC...</div>
        <button id="main-init-btn" class="btn-main" style="margin-top:5px;">ACTIVER_BOUCLE_STABLE</button>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:4px; margin-top:5px;">
            <button onclick="OMNI_CORE.setAnchor()">RE-ZERO</button>
            <button onclick="location.reload()">RELOAD</button>
        </div>
    </div>
</main>

<script>
const m = math;
m.config({ number: 'BigNumber', precision: 64 });
const _BN = (n) => m.bignumber(String(n || 0));

const OMNI_CORE = {
    active: false,
    lastT: performance.now(),
    
    state: {
        vel: _BN(0),
        rot: { a: 0, b: 0, g: 0 },
        bias_z: 0,
        dist: _BN(0)
    },

    PHYS: { G: 9.80665, C: 299792458 },

    async boot() {
        this.log("CALIBRATION DES MATRICES...");
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            await DeviceMotionEvent.requestPermission();
        }

        window.ondevicemotion = (e) => { this.raw_acc = e.accelerationIncludingGravity; };
        window.ondeviceorientation = (e) => { this.state.rot = { a: e.alpha, b: e.beta, g: e.gamma }; };

        setTimeout(() => {
            // On capture le bruit de fond du capteur au repos
            this.state.bias_z = (this.raw_acc.z || 9.81) - this.PHYS.G;
            this.active = true;
            this.log("BOUCLE VERROUILLÉE AU SOL.");
            this.startLoop();
        }, 1200);
    },

    startLoop() {
        // Fréquence fixe pour éviter les dérives de temps (100 Hz)
        setInterval(() => {
            if (!this.active || !this.raw_acc) return;
            
            const now = performance.now();
            const dt = (now - this.lastT) / 1000;
            this.lastT = now;

            // 1. Angles en radians
            const pitch = (this.state.rot.b || 0) * (Math.PI / 180);
            const roll = (this.state.rot.g || 0) * (Math.PI / 180);

            // 2. EXTRACTION DE LA GRAVITÉ (La clé du problème)
            // On calcule exactement combien de G tombe sur chaque axe du téléphone
            const g_local_x = -Math.sin(roll) * Math.cos(pitch) * this.PHYS.G;
            const g_local_y = Math.sin(pitch) * this.PHYS.G;
            const g_local_z = Math.cos(pitch) * Math.cos(roll) * this.PHYS.G;

            // 3. ACCÉLÉRATION LINÉAIRE PURE
            // On soustrait la gravité calculée de la mesure brute
            const ax_pure = this.raw_acc.x - g_local_x;
            const ay_pure = this.raw_acc.y - g_local_y;
            const az_pure = this.raw_acc.z - g_local_z - this.state.bias_z;

            // 4. PROJECTION SUR L'AXE DE MARCHE (Vitesse Horizontale)
            // On projette les forces pour ne garder que ce qui fait avancer l'utilisateur
            const acc_horiz = (ax_pure * Math.cos(pitch)) + (az_pure * Math.sin(pitch));

            // 5. FILTRE DE STASE DYNAMIQUE (Anti-Dérive)
            // Si l'accélération est trop faible (bruit), on force le retour à 0
            const noise_threshold = 0.25; 
            if (Math.abs(acc_horiz) < noise_threshold) {
                this.state.vel = m.multiply(this.state.vel, 0.88); // Friction logicielle
            } else {
                const dv = m.multiply(_BN(acc_horiz), _BN(dt));
                this.state.vel = m.add(this.state.vel, dv);
            }
        }, 10);

        // Rendu UI séparé (60 FPS)
        const render = () => {
            const v = Math.abs(Number(this.state.vel));
            document.getElementById('vitesse-raw').innerText = v.toFixed(6);
            document.getElementById('speed-stable-kmh').innerText = (v * 3.6).toFixed(2);
            document.getElementById('ui-tilt-pitch').innerText = (this.state.rot.b || 0).toFixed(2) + "°";
            document.getElementById('ui-clock').innerText = new Date().toLocaleTimeString();
            
            const gamma = 1 / Math.sqrt(1 - Math.pow(v/this.PHYS.C, 2));
            document.getElementById('ui-lorentz').innerText = gamma.toFixed(12);

            requestAnimationFrame(render);
        };
        requestAnimationFrame(render);
    },

    setAnchor() {
        this.state.vel = _BN(0);
        this.log("RESET EFFECTUÉ.");
    },

    log(msg) {
        const l = document.getElementById('anomaly-log');
        l.innerHTML = `<div>> ${msg}</div>` + l.innerHTML;
    }
};

document.getElementById('main-init-btn').onclick = () => OMNI_CORE.boot();
</script>
</body>
                </html>
