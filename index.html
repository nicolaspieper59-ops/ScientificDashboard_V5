<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCHE V131 • OMNI-SCIENCE CORE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        :root {
            --neon: #00ffcc; --space: #0a0a1a; --warn: #ffcc00; --danger: #ff0055;
            --panel-alpha: rgba(5, 15, 20, 0.95);
        }
        body, html { 
            margin: 0; padding: 0; background: var(--space); 
            color: var(--neon); font-family: 'Courier New', monospace;
            overflow: hidden; height: 100vh;
        }
        #video-bg {
            position: fixed; inset: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 0.3; z-index: 1; filter: grayscale(1) contrast(1.5);
        }
        #map-overlay {
            position: fixed; bottom: 20px; right: 20px; width: 350px; height: 350px;
            border: 1px solid var(--neon); z-index: 10; filter: invert(1) hue-rotate(180deg);
            clip-path: polygon(0 0, 100% 0, 100% 85%, 85% 100%, 0 100%);
        }
        .hud-layer {
            position: fixed; inset: 0; z-index: 100; pointer-events: none;
            display: grid; grid-template-columns: 380px 1fr 380px; padding: 20px; gap: 20px;
        }
        .panel {
            background: var(--panel-alpha); border: 1px solid rgba(0, 255, 204, 0.2);
            padding: 15px; pointer-events: auto; backdrop-filter: blur(10px);
            display: flex; flex-direction: column; gap: 10px;
        }
        .label { font-size: 0.7rem; letter-spacing: 2px; opacity: 0.6; }
        .data { font-size: 1.1rem; color: #fff; text-shadow: 0 0 5px var(--neon); }
        
        /* Reticule & Horizon */
        .center-ui { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #gyro-scope {
            width: 450px; height: 450px; border: 2px solid rgba(0, 255, 204, 0.1);
            border-radius: 50%; position: relative;
        }
        #horizon-line {
            position: absolute; top: 50%; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--neon), transparent);
            box-shadow: 0 0 15px var(--neon);
        }
        #sigma-ellipse {
            position: absolute; border: 1px dashed var(--warn); border-radius: 50%;
            transition: all 0.1s ease;
        }

        /* Buttons */
        button {
            background: none; border: 1px solid var(--neon); color: var(--neon);
            padding: 10px; cursor: pointer; text-transform: uppercase; font-weight: bold;
        }
        button:hover { background: var(--neon); color: var(--space); }
        .rec-active { animation: blink 1s infinite; border-color: var(--danger); color: var(--danger); }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

<video id="video-bg" autoplay playsinline muted></video>
<div id="map-overlay"></div>

<div class="hud-layer">
    <div class="panel">
        <div style="font-size: 1.5rem; font-weight: 900;">ARCHE V131</div>
        <div id="sys-status" style="color: var(--warn);">STANDBY: CALIBRATION NEEDED</div>
        <hr style="border: 0.5px solid rgba(0,255,204,0.2); width: 100%;">
        
        <div class="label">MÉTRIQUE DE SCHWARZSCHILD</div>
        <div id="v-metric" class="data">--.------------</div>
        
        <div class="label">G-LOCAL (MARSEILLE)</div>
        <div id="v-gravity" class="data">--.------ m/s²</div>
        
        <div class="label">MARÉE SOLIDE (LOVE)</div>
        <div id="v-tide" class="data">--.---- cm</div>
        
        <div class="label">RÉFRACTION D'EDLÉN</div>
        <div id="v-refract" class="data">--.------ n</div>
    </div>

    <div class="center-ui">
        <div id="gyro-scope">
            <div id="horizon-line"></div>
            <div id="sigma-ellipse"></div>
        </div>
        <div id="v-speed" style="font-size: 4rem; font-weight: 900; margin-top: 20px;">0.000 <span style="font-size: 1rem;">M/S</span></div>
    </div>

    <div class="panel">
        <div class="label">SLAM COVARIANCE (Σ)</div>
        <div id="v-sigma" class="data" style="color: var(--warn);">± --.---- m</div>

        <div class="label">WGS84 LATITUDE</div>
        <div id="v-lat" class="data">43.2965000000</div>
        
        <div class="label">WGS84 LONGITUDE</div>
        <div id="v-lon" class="data">5.3698000000</div>

        <div class="label">ENTROPIE QUANTIQUE</div>
        <div id="v-entropy" class="data">--.---- bits</div>

        <button id="btn-init" onclick="ENGINE.init()">INITIALISER SIGMA-1</button>
        <button id="btn-log" onclick="ENGINE.toggleLog()">MISSION LOG: OFF</button>
        <button onclick="ENGINE.exportCSV()" style="border-color: var(--warn); color: var(--warn);">EXPORTER DATA 128-BIT</button>
    </div>
</div>

<script>
/**
 * CORE ENGINE ARCHE V131
 * Strictly Zero-Simulation. 
 */
const ENGINE = {
    origin: { lat: 43.296482, lon: 5.36978, alt: 11 }, // Ref Marseille
    pos: { x: math.bignumber(0), y: math.bignumber(0) },
    v: { x: math.bignumber(0), y: math.bignumber(0) },
    P: math.bignumber(0.01), // Matrice de covariance initiale
    isRecording: false,
    logs: [],

    async init() {
        document.getElementById('sys-status').innerText = "SYNCING WITH EARTH ROTATION...";
        document.getElementById('btn-init').style.display = 'none';

        // 1. Hardware Access
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            document.getElementById('video-bg').srcObject = stream;
        } catch(e) { console.error("Optical sensor blocked"); }

        // 2. Map Setup
        this.map = L.map('map-overlay', { zoomControl: false, attributionControl: false }).setView([this.origin.lat, this.origin.lon], 18);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.map);
        this.marker = L.circleMarker([this.origin.lat, this.origin.lon], { color: '#00ffcc', radius: 5 }).addTo(this.map);

        // 3. Sensor Fusion Start
        this.startPhysicsInference();
        document.getElementById('sys-status').innerText = "V131 OPERATIONAL [OMNI-SCIENCE]";
        document.getElementById('sys-status').style.color = "var(--neon)";
    },

    startPhysicsInference() {
        let lastT = performance.now();
        
        window.addEventListener('devicemotion', (e) => {
            const now = performance.now();
            const dt = math.bignumber((now - lastT) / 1000);
            lastT = now;

            // --- CALCULS DE PHYSIQUE BRUTE ---
            
            // 1. Gravité locale corrigée (Somigliana + Bouguer)
            const g_local = this.computeGLocal(this.origin.lat, this.origin.alt);
            document.getElementById('v-gravity').innerText = g_local.toFixed(6) + " m/s²";

            // 2. Compensation Coriolis
            const v_vector = [this.v.x, this.v.y];
            const omega_e = math.bignumber(7.292115e-5);
            const coriolis = math.multiply(2, omega_e, math.sin(this.origin.lat * Math.PI/180));

            // 3. Intégration de Verlet (Position)
            if (e.acceleration.x) {
                let ax = math.subtract(math.bignumber(e.acceleration.x), math.multiply(coriolis, this.v.y));
                let ay = math.add(math.bignumber(e.acceleration.y), math.multiply(coriolis, this.v.x));

                this.v.x = math.add(this.v.x, math.multiply(ax, dt));
                this.v.y = math.add(this.v.y, math.multiply(ay, dt));
                
                this.pos.x = math.add(this.pos.x, math.multiply(this.v.x, dt));
                this.pos.y = math.add(this.pos.y, math.multiply(this.v.y, dt));
            }

            // 4. Propagation d'incertitude (Kalman Sigma)
            this.P = math.add(this.P, math.multiply(0.0001, dt)); // Random Walk
            
            this.updateUI();
        });

        window.addEventListener('deviceorientation', (e) => {
            document.getElementById('horizon-line').style.transform = `rotate(${e.gamma}deg) translateY(${e.beta}px)`;
        });
    },

    computeGLocal(lat, alt) {
        // Formule internationale de la pesanteur
        const phi = lat * Math.PI / 180;
        const g0 = 9.780327 * (1 + 0.0053024 * Math.sin(phi)**2 - 0.0000058 * Math.sin(2*phi)**2);
        const dg = -0.000003086 * alt; // Correction d'air libre
        return math.bignumber(g0 + dg);
    },

    updateUI() {
        // WGS84 Vincenty Conversion (Simplified for JS)
        const R = 6378137;
        const curLat = this.origin.lat + (math.toNumber(this.pos.y) / R) * (180 / Math.PI);
        const curLon = this.origin.lon + (math.toNumber(this.pos.x) / (R * Math.cos(this.origin.lat * Math.PI / 180))) * (180 / Math.PI);

        document.getElementById('v-lat').innerText = curLat.toFixed(10);
        document.getElementById('v-lon').innerText = curLon.toFixed(10);
        
        const speed = math.sqrt(math.add(math.square(this.v.x), math.square(this.v.y)));
        document.getElementById('v-speed').firstChild.textContent = math.toNumber(speed).toFixed(3) + " ";

        const sigma = math.sqrt(this.P);
        document.getElementById('v-sigma').innerText = `± ${math.toNumber(sigma).toFixed(4)} m`;
        
        // Ellipse Update
        const ell = document.getElementById('sigma-ellipse');
        const size = math.toNumber(math.multiply(sigma, 50));
        ell.style.width = size + "px"; ell.style.height = size + "px";

        this.marker.setLatLng([curLat, curLon]);

        if(this.isRecording) {
            this.logs.push({ t: performance.now(), lat: curLat, lon: curLon, v: math.toNumber(speed) });
        }
    },

    toggleLog() {
        this.isRecording = !this.isRecording;
        const btn = document.getElementById('btn-log');
        btn.classList.toggle('rec-active');
        btn.innerText = this.isRecording ? "RECORDING MISSION..." : "MISSION LOG: OFF";
    },

    exportCSV() {
        let csv = "Timestamp_ms,Latitude,Longitude,Velocity_ms\n";
        this.logs.forEach(l => { csv += `${l.t},${l.lat},${l.lon},${l.v}\n`; });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `ARCHE_V131_DATA_${Date.now()}.csv`;
        a.click();
    }
};
</script>
</body>
            </html>
