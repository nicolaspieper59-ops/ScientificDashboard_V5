<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOUVERAIN V100 - ARCHÈ VSOP2013</title>
    <script src="ephem.js"></script>
    <style>
        :root { --gold: #ffcc00; --neon: #00ff88; --bg: #010101; --panel: rgba(0, 15, 10, 0.95); }
        body { background: var(--bg); color: var(--neon); font-family: 'Courier New', monospace; margin: 0; overflow: hidden; }
        .hud { display: grid; grid-template-columns: 1fr 400px; height: 100vh; }
        .vision-sector { position: relative; border-right: 2px solid var(--gold); background: #000; }
        #camera-feed { width: 100%; height: 100%; object-fit: cover; opacity: 0.4; filter: grayscale(1); }
        
        .reticule { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 250px; height: 250px; border: 1px solid rgba(255, 204, 0, 0.2); border-radius: 50%; 
        }
        #analemma-map { position: absolute; bottom: 20px; right: 20px; border: 1px solid var(--gold); background: rgba(0,0,0,0.8); }

        .sidebar { background: var(--panel); padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .card { border: 1px solid var(--neon); padding: 10px; background: rgba(0, 30, 15, 0.4); }
        .card-gold { border: 1px solid var(--gold); }
        
        .label { font-size: 0.65rem; color: var(--gold); text-transform: uppercase; }
        .val { color: #fff; font-size: 1.3rem; font-weight: bold; font-variant-numeric: tabular-nums; }
        .sub { font-size: 0.7rem; color: #888; }
        
        button { background: var(--gold); color: #000; border: none; padding: 12px; font-weight: bold; cursor: pointer; width: 100%; }
        .btn-exp { background: #ff4444; color: white; margin-top: auto; }
    </style>
</head>
<body>

<div class="hud">
    <div class="vision-sector">
        <video id="camera-feed" autoplay playsinline></video>
        <div class="reticule"></div>
        <canvas id="analemma-map" width="180" height="240"></canvas>
        
        <div style="position:absolute; top:20px; left:20px; pointer-events:none;">
            <h2 style="color:var(--gold); margin:0;">ARCHÈ V100</h2>
            <div id="hsv-clock" class="val" style="font-size: 2.8rem;">--:--:--.---</div>
            <div id="hsm-clock" class="sub" style="color:var(--gold)">HEURE SOLAIRE MOYENNE: --:--:--</div>
        </div>
    </div>

    <div class="sidebar">
        <button onclick="Souverain.init()">ACTIVER LE NOYAU VSOP2013</button>

        <div class="card card-gold">
            <div class="label">Équation du Temps (Delta Céleste)</div>
            <div id="eot-val" class="val">-- min -- s</div>
            <div class="sub">Source: ephem.js / Vecteur EMB</div>
        </div>

        <div class="card">
            <div class="label">Relativité & Lorentz (128-bit)</div>
            <div class="sub">γ mesuré par accélération :</div>
            <span id="gamma-val" class="val">--</span>
            <div class="sub">Latence d'échantillonnage : <span id="lat-hw">--</span> ms</div>
        </div>

        <div class="card">
            <div class="label">Gravité Locale (Marseille 9.805)</div>
            <div style="display:flex; justify-content:space-between;">
                <div>G: <span id="g-val" class="val">--</span></div>
                <div>P: <span id="p-val" class="val">--</span></div>
            </div>
            <div id="struct-diag" class="sub">Scan gravitationnel en attente...</div>
        </div>

        <div class="card">
            <div class="label">Analyse Optique (Lune/Soleil)</div>
            <span id="target-id" class="val">--</span>
            <div id="lunar-phase" class="sub">Illumination : --%</div>
        </div>

        <button class="btn-exp" onclick="Expedition.toggle()">MODE EXPÉDITION [OFF]</button>
    </div>
</div>

<script>
const Souverain = {
    LON_MARSEILLE: 5.3587,
    C: 299792458,
    isEngineReady: false,

    async init() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            document.getElementById('camera-feed').srcObject = stream;
        } catch(e) { console.error("Accès optique refusé"); }

        if (typeof vsop2013 !== 'undefined') {
            this.isEngineReady = true;
            this.drawAnalemmaBase();
        }
        
        this.startSensors();
        this.mainLoop();
    },

    startSensors() {
        window.addEventListener('devicemotion', (e) => {
            const a = e.accelerationIncludingGravity;
            const v = e.acceleration;
            if(!a || !v) return;

            const g = Math.sqrt(a.x**2 + a.y**2 + a.z**2);
            const vel = Math.sqrt(v.x**2 + v.y**2 + v.z**2);
            const gamma = 1 / Math.sqrt(1 - (Math.pow(vel, 2) / Math.pow(this.C, 2)));

            document.getElementById('g-val').innerText = g.toFixed(5);
            document.getElementById('gamma-val').innerText = gamma.toFixed(14);
            document.getElementById('lat-hw').innerText = (performance.now() - e.timeStamp).toFixed(2);
        });

        if ('PressureSensor' in window) {
            const ps = new PressureSensor({frequency: 10});
            ps.onreading = () => document.getElementById('p-val').innerText = ps.pressure.toFixed(3);
            ps.start();
        }
    },

    drawAnalemmaBase() {
        const canvas = document.getElementById('analemma-map');
        const ctx = canvas.getContext('2d');
        ctx.strokeStyle = '#222';
        ctx.beginPath();
        for (let i = 0; i < 365; i++) {
            const b = (2 * Math.PI * (i - 81)) / 365;
            const x = 90 + (9.87 * Math.sin(2 * b) - 7.53 * Math.cos(b)) * 4;
            const y = 120 - (23.44 * Math.sin((2 * Math.PI * (i - 80)) / 365)) * 4;
            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        }
        ctx.stroke();
    },

    mainLoop() {
        const loop = () => {
            const now = new Date();
            const jd = (now.getTime() / 86400000.0) + 2440587.5;
            const t = (jd - 2451545.0) / 36525.0;

            if (this.isEngineReady) {
                const pos = vsop2013.emb.position(t);
                const L = (280.466 + 36000.77 * t) % 360;
                const alpha = Math.atan2(pos.y, pos.x) * (180 / Math.PI) + 180;
                const eotMin = 4 * (L - alpha);

                document.getElementById('eot-val').innerText = `${eotMin.toFixed(2)} min`;

                // Heure Solaire Moyenne (Calculée par Longitude)
                const utcMs = now.getTime() + (now.getTimezoneOffset() * 60000);
                const hsmMs = utcMs + (this.LON_MARSEILLE * 4 * 60 * 1000);
                
                // Heure Solaire Vraie (HSM + Équation du Temps)
                const hsvMs = hsmMs + (eotMin * 60 * 1000);

                this.updateUI(hsmMs, hsvMs, eotMin);
            }
            requestAnimationFrame(loop);
        };
        requestAnimationFrame(loop);
    },

    updateUI(hsm, hsv, eot) {
        const format = (ms) => new Date(ms).toISOString().substr(11, 12);
        document.getElementById('hsm-clock').innerText = `HEURE SOLAIRE MOYENNE: ${format(hsm)}`;
        document.getElementById('hsv-clock').innerText = format(hsv);
    }
};

const Expedition = {
    active: false,
    toggle() {
        this.active = !this.active;
        document.querySelector('.btn-exp').innerText = this.active ? "ENREGISTREMENT..." : "MODE EXPÉDITION [OFF]";
    }
};
</script>
</body>
</html>
