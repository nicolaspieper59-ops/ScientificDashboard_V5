<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCHÈ V6500 | TRUE-ZERO CALIBRATION</title>
    <style>
        :root { --blue: #00d4ff; --red: #ff4444; --green: #00ff88; --bg: #020202; }
        body { background: var(--bg); color: white; font-family: 'Consolas', monospace; margin: 0; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        #hud { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 4px; padding: 10px; }
        .card { background: #08080a; border: 1px solid #1a1a1c; padding: 12px; position: relative; }
        .label { font-size: 0.6rem; color: #444; text-transform: uppercase; }
        .val { font-size: 2.2rem; color: var(--blue); font-weight: bold; }
        #terminal { height: 25vh; background: #000; border-top: 1px solid var(--blue); padding: 10px; font-size: 0.7rem; overflow-y: auto; color: #0f0; }
        
        /* Overlay de Calibration */
        #calib-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .loader { width: 200px; height: 2px; background: #222; margin-top: 20px; position: relative; }
        #loader-fill { height: 100%; width: 0%; background: var(--blue); transition: width 0.1s; }
        button { background: none; border: 1px solid var(--blue); color: var(--blue); padding: 15px 30px; cursor: pointer; text-transform: uppercase; }
    </style>
</head>
<body>

<div id="calib-overlay">
    <div id="calib-msg">SYSTÈME PRÊT<br><small>Posez l'appareil sur une surface stable</small></div>
    <div class="loader"><div id="loader-fill"></div></div>
    <br>
    <button id="start-btn" onclick="startCalibration()">Lancer Calibration</button>
</div>

<div id="hud">
    <div class="card">
        <div class="label">Vitesse de Vérité</div>
        <div id="v-val" class="val">0.00</div>
        <div style="font-size:0.6rem; color:#444">BIAIS ANNULÉ: <span id="bias-val">0.000</span></div>
    </div>
    <div class="card">
        <div class="label">État du Voxel</div>
        <div id="motion-txt" class="val" style="font-size:1.2rem">SCANNING...</div>
    </div>
</div>

<div id="terminal"></div>

<script>
    let state = { v: 0, lastT: performance.now(), bias: 0, isCalibrated: false };
    let calibSamples = [];

    // 1. PHASE DE CALIBRATION (RÉALISME SCIENTIFIQUE)
    function startCalibration() {
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('calib-msg').innerHTML = "CALIBRATION EN COURS...<br>NE PAS TOUCHER";
        
        let count = 0;
        const calibInterval = setInterval(() => {
            count++;
            document.getElementById('loader-fill').style.width = (count / 50 * 100) + "%";
            
            if (count >= 50) {
                clearInterval(calibInterval);
                finalizeCalibration();
            }
        }, 100);

        window.addEventListener('devicemotion', captureBias);
    }

    function captureBias(e) {
        if (state.isCalibrated) return;
        let a = e.acceleration;
        if (a) {
            let mag = Math.sqrt(a.x**2 + a.y**2 + a.z**2);
            calibSamples.push(mag);
        }
    }

    function finalizeCalibration() {
        // Calcul du bruit moyen du S10e (Le Biais)
        const sum = calibSamples.reduce((a, b) => a + b, 0);
        state.bias = sum / calibSamples.length;
        state.isCalibrated = true;
        
        document.getElementById('calib-overlay').style.display = 'none';
        document.getElementById('bias-val').innerText = state.bias.toFixed(4);
        log("Calibration terminée. Biais résiduel soustrait.");
        startEngine();
    }

    // 2. MOTEUR DE VÉRITÉ SOUVERAIN
    function startEngine() {
        window.addEventListener('devicemotion', (e) => {
            const now = performance.now();
            const dt = (now - state.lastT) / 1000;
            state.lastT = now;

            let acc = e.acceleration;
            if (!acc) return;

            // ON SOUSTRAIT LE BIAIS RÉEL MESURÉ
            let rawMag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
            let aCorrected = rawMag - state.bias;

            // FILTRE DE VÉRITÉ
            if (aCorrected < 0.02) { // Seuil après soustraction du biais
                state.v *= 0.95; 
            } else {
                state.v += (aCorrected * dt);
            }

            if (state.v < 0.01) state.v = 0;
            updateUI();
        });
    }

    function updateUI() {
        document.getElementById('v-val').innerText = state.v.toFixed(2);
    }

    function log(m) {
        const t = document.getElementById('terminal');
        t.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${m}</div>` + t.innerHTML;
    }
</script>
</body>
</html>
