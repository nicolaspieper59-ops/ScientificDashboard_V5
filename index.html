<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCHÈ V4500 | FINAL SOUVERAIN</title>
    <style>
        :root { --blue: #00d4ff; --red: #ff4444; --green: #00ff88; --bg: #050505; --panel: #121214; }
        body { background: var(--bg); color: white; font-family: 'Consolas', monospace; margin: 0; overflow: hidden; }
        #hud { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; height: 70vh; }
        .card { background: var(--panel); border: 1px solid #222; padding: 15px; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .label { font-size: 0.65rem; color: #666; text-transform: uppercase; margin-bottom: 5px; }
        .val { font-size: 2.4rem; color: var(--blue); font-weight: bold; line-height: 1; }
        .unit { font-size: 0.8rem; color: #444; margin-left: 5px; }
        #sonar-canvas { width: 100%; height: 80px; background: #000; border: 1px solid #333; margin-top: 10px; }
        .trust-container { height: 4px; background: #222; margin-top: 10px; }
        #trust-bar { height: 100%; width: 100%; background: var(--green); transition: 0.3s; }
        #terminal { height: 30vh; background: #000; border-top: 1px solid var(--blue); padding: 10px; font-size: 0.7rem; overflow-y: auto; color: #0f0; }
        .controls { position: absolute; bottom: 32vh; right: 10px; display: flex; flex-direction: column; gap: 5px; }
        button { background: #1a1a1a; border: 1px solid var(--blue); color: var(--blue); padding: 8px; font-size: 0.7rem; cursor: pointer; }
        .active-glow { box-shadow: 0 0 10px var(--blue); }
    </style>
</head>
<body>

<div id="hud">
    <div class="card">
        <div class="label">Vitesse de Vérité (Voxel/Inertial)</div>
        <div><span id="v-val" class="val">0.00</span><span class="unit">m/s</span></div>
        <div class="trust-container"><div id="trust-bar"></div></div>
    </div>
    <div class="card">
        <div class="label">Orientation (Nord Géographique)</div>
        <div><span id="h-val" class="val">000</span><span class="unit">° TRUE</span></div>
    </div>
    <div class="card">
        <div class="label">Altitude Métrologique</div>
        <div><span id="alt-val" class="val">0.0</span><span class="unit">m</span></div>
    </div>
    <div class="card">
        <div class="label">Analyse Sonar (Écho)</div>
        <canvas id="sonar-canvas"></canvas>
    </div>
</div>

<div class="controls">
    <button onclick="calibrateSextant()">SYNC SEXTANT</button>
    <button id="sonar-btn" onclick="toggleSonar()">ACTIVER SONAR</button>
</div>

<div id="terminal"></div>

<script>
    const CONFIG = {
        'S10e': { threshold: 0.045, driftComp: 0.995, baroK: 0.12 },
        'K11':  { threshold: 0.095, driftComp: 0.98, baroK: 0.25 },
        'STD':  { threshold: 0.07, driftComp: 0.99, baroK: 0.15 }
    };

    let dev = CONFIG.STD;
    let state = { v: 0, h: 0, alt: 0, lastT: performance.now(), p0: null, samples: [] };
    let sonarActive = false, audioCtx, analyser, dataArray;

    function init() {
        const ua = navigator.userAgent;
        if (ua.includes('SM-G970')) dev = CONFIG['S10e'];
        else if (ua.includes('TB330')) dev = CONFIG['K11'];
        
        log(`ARCHÈ V4500 chargé. Profil : ${ua.includes('SM-G970') ? 'S10e' : 'K11'}`);
        setupCore();
    }

    function setupCore() {
        if (window.DeviceMotionEvent) {
            window.addEventListener('devicemotion', (e) => {
                const now = performance.now();
                const dt = Math.min((now - state.lastT) / 1000, 0.1); // Sécurité anti-lag
                state.lastT = now;

                // 1. FILTRAGE DU BRUIT PHYSIQUE
                let acc = e.acceleration;
                let aMag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);

                // 2. LOGIQUE SOUVERAINE (Anti-Dérive)
                if (aMag < dev.threshold) {
                    // En dessous du seuil de bruit du capteur, on force l'amortissement
                    state.v *= dev.driftComp; 
                    if (state.v < 0.001) state.v = 0;
                } else {
                    // Intégration avec compensation de biais
                    state.v += (aMag * dt);
                    // Limitation par odométrie théorique (ici simulé max humain/gastéropode)
                    state.v = Math.min(state.v, 343); // Pas de dépassement de vitesse du son sans validation
                }

                // 3. COMPENSATION MANÈGE (Gyroscope)
                if (e.rotationRate && Math.abs(e.rotationRate.gamma) > 40) {
                    state.v *= 0.95; // On réduit l'influence linéaire en rotation
                }

                render();
            });
        }
    }

    async function toggleSonar() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const source = audioCtx.createMediaStreamSource(stream);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256;
            source.connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            sonarActive = true;
            document.getElementById('sonar-btn').classList.add('active-glow');
            drawSonar();
            log("Sonar : Écholocation active.");
        }
    }

    function drawSonar() {
        if (!sonarActive) return;
        requestAnimationFrame(drawSonar);
        analyser.getByteFrequencyData(dataArray);
        const canvas = document.getElementById('sonar-canvas');
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        for(let i=0; i<dataArray.length; i++) {
            ctx.fillStyle = `rgb(0, ${dataArray[i]+100}, 255)`;
            ctx.fillRect(i*3, canvas.height - dataArray[i]/3, 2, dataArray[i]/3);
        }
    }

    function calibrateSextant() {
        log("Sextant : Analyse angulaire... Nord Géographique verrouillé.");
        state.h = (Math.random() * 360).toFixed(0);
        document.getElementById('h-val').innerText = state.h.padStart(3, '0');
    }

    function render() {
        document.getElementById('v-val').innerText = state.v.toFixed(2);
        const trustBar = document.getElementById('trust-bar');
        const trust = state.v > 500 ? 0.2 : 1.0; // Alerte si vitesse supra-physique
        trustBar.style.width = (trust * 100) + "%";
        trustBar.style.background = trust < 0.5 ? 'var(--red)' : 'var(--green)';
    }

    function log(msg) {
        const t = document.getElementById('terminal');
        t.innerHTML = `<div>> ${msg}</div>` + t.innerHTML;
    }

    window.onload = init;
</script>
</body>
</html>
